{% extends 'base.html.twig' %}
{% block title %}Fahrzeug-Route{% endblock %}
{% block body %}
<div class="container py-3">
  <h3><i class="bi bi-geo"></i> Route anzeigen</h3>

  <form id="route-form" class="row g-2 align-items-end mb-3">
    <div class="col-12 col-md-3">
      <label class="form-label">Fahrzeug</label>
      <select id="vehicleId" class="form-select">
        {% for v in vehicles %}
          <option value="{{ v.id }}">{{ v.vehicleNumber ?? '' }} — {{ v.licensePlate ?? '' }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Von</label>
      <input id="from" type="datetime-local" class="form-control" required>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Bis</label>
      <input id="to" type="datetime-local" class="form-control" required>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Vereinfachen (m)</label>
      <input id="simplify" type="number" min="0" step="1" class="form-control" placeholder="0">
    </div>
    <div class="col-6 col-md-1 d-grid">
      <button class="btn btn-primary" type="submit">Zeigen</button>
    </div>

    {# Deutlich sichtbarer GPX-Button #}
    <div class="col-12 col-md-3 d-grid">
      <button id="btn-gpx" class="btn btn-success btn-lg fw-bold" type="button" aria-label="Route als GPX exportieren">
        <i class="bi bi-file-earmark-arrow-down me-1"></i>
        Als GPX exportieren
      </button>
    </div>
  </form>

  <div class="card mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-6 col-md-3"><strong>Distanz:</strong> <span id="stat-distance">–</span></div>
        <div class="col-6 col-md-3"><strong>Dauer:</strong> <span id="stat-duration">–</span></div>
        <div class="col-6 col-md-3"><strong>Ø-Speed:</strong> <span id="stat-speed">–</span></div>
        <div class="col-6 col-md-3"><strong>Zeitraum:</strong> <span id="stat-range">–</span></div>
      </div>
    </div>
  </div>

  <div id="map" style="height: 65vh; border-radius: 12px; position: relative;"></div>

  {# Floating Action Button (GPX) – immer sichtbar über der Karte #}
  <button id="btn-gpx-fab" type="button" class="btn btn-success btn-fab" title="Als GPX exportieren" aria-label="Als GPX exportieren">
    <i class="bi bi-file-earmark-arrow-down"></i>
  </button>
</div>

<style>
  /* Floating Action Button Styling */
  #btn-gpx-fab {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 1040; /* über Karte/Controls */
  }
  .btn-fab {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(0,0,0,.18);
  }
  .btn-fab i {
    font-size: 1.35rem;
    line-height: 1;
  }
</style>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<script>
  const STYLE_URL = '{{ tiles_style_url|default("https://tiles.joormann-media.de/styles/basic/style.json") }}';

  const map = new maplibregl.Map({
    container: 'map',
    style: STYLE_URL,
    center: [6.62, 51.65],
    zoom: 11
  });

  const routeSourceId = 'route-source';
  const routeLayerId  = 'route-line';
  let startMarker = null, endMarker = null;

  function ensureRouteLayer(cb) {
    if (map.getSource(routeSourceId)) return cb();
    if (map.isStyleLoaded()) {
      map.addSource(routeSourceId, { type: 'geojson', data: { type:'FeatureCollection', features: [] } });
      map.addLayer({
        id: routeLayerId, type: 'line', source: routeSourceId,
        paint: { 'line-width': 4, 'line-color': '#ff2d55' }
      });
      return cb();
    }
    map.once('load', () => {
      map.addSource(routeSourceId, { type: 'geojson', data: { type:'FeatureCollection', features: [] } });
      map.addLayer({
        id: routeLayerId, type: 'line', source: routeSourceId,
        paint: { 'line-width': 4, 'line-color': '#ff2d55' }
      });
      cb();
    });
  }

  function fmtDist(m){ return (m/1000).toFixed(2) + ' km'; }
  function fmtDur(s){
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
    return h>0 ? `${h}h ${m}m` : (m>0 ? `${m}m ${sec}s` : `${sec}s`);
  }

  function buildRouteUrl(params = {}) {
    const url = new URL('{{ path("app_vehicle_tracking_route_data") }}', window.location.origin);
    Object.entries(params).forEach(([k,v]) => {
      if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
    });
    return url;
  }

  async function loadRoute(vehicleId, from, to, simplify) {
    const url = buildRouteUrl({ vehicleId, from, to, simplify });
    console.log('[ROUTE] fetch', url.toString());
    const res = await fetch(url, {
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin'
    });
    if (!res.ok) {
      console.error('[ROUTE] HTTP', res.status, await res.text());
      alert(`Fehler ${res.status} beim Laden der Route.`);
      return;
    }
    const geo = await res.json();
    console.log('[ROUTE] response', geo);

    ensureRouteLayer(() => {
      const feat = geo.features?.[0];
      if (!feat) {
        document.getElementById('stat-distance').innerText = '–';
        document.getElementById('stat-duration').innerText = '–';
        document.getElementById('stat-speed').innerText = '–';
        document.getElementById('stat-range').innerText = '–';
        map.getSource(routeSourceId).setData({ type:'FeatureCollection', features: [] });
        if (startMarker) startMarker.remove();
        if (endMarker) endMarker.remove();
        return;
      }

      const p = feat.properties || {};
      document.getElementById('stat-distance').innerText = fmtDist(p.distanceMeters || 0);
      document.getElementById('stat-duration').innerText = fmtDur(p.durationSeconds || 0);
      document.getElementById('stat-speed').innerText = ((p.avgSpeedKmh||0)) + ' km/h';
      document.getElementById('stat-range').innerText = (p.startTime||'–') + ' → ' + (p.endTime||'–');

      map.getSource(routeSourceId).setData(geo);

      const coords = feat.geometry?.coordinates || [];
      if (coords.length >= 2) {
        if (startMarker) startMarker.remove();
        if (endMarker) endMarker.remove();
        startMarker = new maplibregl.Marker({color:'#2ecc71'}).setLngLat(coords[0]).addTo(map);
        endMarker   = new maplibregl.Marker({color:'#e74c3c'}).setLngLat(coords[coords.length-1]).addTo(map);

        const b = coords.reduce((b, c) => b.extend(c), new maplibregl.LngLatBounds(coords[0], coords[0]));
        map.fitBounds(b, { padding: 60, duration: 500 });
      }
    });
  }

  // --- Submit-Handler (kein Reload) ---
  const form = document.getElementById('route-form');
  form.setAttribute('action', 'javascript:void(0)');
  form.addEventListener('submit', (e) => {
    e.preventDefault(); e.stopPropagation();
    const vehicleId = document.getElementById('vehicleId').value;
    const from = document.getElementById('from').value;
    const to   = document.getElementById('to').value;
    const simplify = document.getElementById('simplify').value || 0;
    if (!vehicleId || !from || !to) {
      alert('Fahrzeug und Zeitraum auswählen.'); return;
    }
    loadRoute(vehicleId, from, to, simplify);
  });

  // --- GPX-Export Logik (Form-Button & FAB nutzen dieselbe Funktion) ---
  function exportGpx() {
    const vehicleId = document.getElementById('vehicleId').value;
    const from = document.getElementById('from').value;
    const to   = document.getElementById('to').value;
    const simplify = document.getElementById('simplify').value || '';
    if (!vehicleId || !from || !to) {
      alert('Für GPX bitte Fahrzeug und Zeitraum wählen.'); return;
    }
    const url = buildRouteUrl({ vehicleId, from, to, simplify, format: 'gpx' });
    window.open(url.toString(), '_blank');
  }
  document.getElementById('btn-gpx').addEventListener('click', exportGpx);
  document.getElementById('btn-gpx-fab').addEventListener('click', exportGpx);

  // --- Lokale Datumswerte für datetime-local (ohne UTC-Shift) ---
  function toLocalInputValue(d) {
    const pad = n => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  (function initDefaults(){
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    document.getElementById('from').value = toLocalInputValue(new Date(today.getTime() + 6*3600*1000));  // 06:00 lokal
    document.getElementById('to').value   = toLocalInputValue(new Date(today.getTime() + 20*3600*1000)); // 20:00 lokal
  })();
</script>

{% endblock %}
