<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Tour-Karte</title>
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body, #map { margin:0; padding:0; height:100%; width:100%; }

    #search-container {
      position: absolute; top: 10px; left: 10px; z-index: 5000;
      width: 260px; background: white; padding: 8px; border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #search-results {
      position: absolute; top: 40px; left: 0; right: 0;
      background: white; border: 1px solid #ccc; border-top: none;
      z-index: 6000; max-height: 220px; overflow-y: auto;
    }
    #search-results button {
      display:block; width:100%; padding:6px; border:none; background:white; text-align:left; cursor:pointer;
    }
    #search-results button:hover { background:#f0f0f0; }

    .context-popup {
      position: absolute; background: white; border: 1px solid #aaa; padding: 6px;
      border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 10000;
    }
    .context-popup button {
      display:block; width:100%; border:none; background:white; padding:6px; text-align:left; cursor:pointer;
    }
    .context-popup button:hover { background:#eee; }

    #info {
      position: absolute; bottom: 10px; left: 10px; z-index: 4000;
      background: rgba(255,255,255,0.9); padding: 8px 10px; border-radius: 4px;
      font-family: system-ui, Arial, sans-serif; box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }
    #route-data {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 5000;
  width: 320px;
  background: white;
  padding: 8px;
  border-radius: 4px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  font-family: monospace;
}

  </style>
</head>
<body>
  <div id="kid-modal" style="
  display:none; 
  position:fixed; 
  top:50%; left:50%; 
  transform:translate(-50%,-50%);
  background:white; 
  border:1px solid #ccc; 
  border-radius:8px;
  padding:16px; 
  z-index:10001; 
  width:400px; 
  max-height:70vh; 
  overflow:auto;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
">
  <h3>üëß Kinder ausw√§hlen</h3>
  <div id="kid-list"></div>
  <div style="margin-top:10px;text-align:right;">
    <button id="kid-cancel">‚ùå Abbrechen</button>
    <button id="kid-assign">‚úÖ Zuordnen</button>
  </div>
</div>
  <div id="map"></div>
  <div id="info">‚ÑπÔ∏è Keine Route geladen</div>

  <div id="search-container">
    <input id="search-input" type="text" placeholder="Adresse eingeben..." />
    <div id="search-results"></div>
  </div>
  <div id="route-data">
  <h4>üìÑ Route Daten</h4>
  <pre id="route-json" style="max-height:200px;overflow:auto;font-size:11px;background:#f8f9fa;padding:6px;border:1px solid #ccc;border-radius:4px;"></pre>
  <h5>GPX</h5>
  <pre id="route-gpx" style="max-height:150px;overflow:auto;font-size:11px;background:#f8f9fa;padding:6px;border:1px solid #ccc;border-radius:4px;"></pre>
</div>


<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<script>
  // === Twig Variablen als sichere JS-Config ===
  const CONFIG = {
    tourId: {{ (school_tour is defined ? school_tour.id : null)|json_encode|raw }},
    schoolId: {{ (school_tour is defined and school_tour.school ? school_tour.school.id : null)|json_encode|raw }},
    savedRoute: {{ saved_route|default('null')|raw }},
    stops: [
      {% if school_tour is defined and school_tour.stops is defined %}
        {% for stop in school_tour.stops %}
          {
            "id": {{ stop.id|json_encode|raw }},
            "address": {{ stop.address|default('')|json_encode|raw }},
            "lat": {{ stop.latitude|default(null)|json_encode|raw }},
            "lng": {{ stop.longitude|default(null)|json_encode|raw }},
            "kids": [
              {% for kid in stop.kids %}
                {"id": {{ kid.id|json_encode|raw }}, "name": {{ kid.name|json_encode|raw }}}
                {% if not loop.last %},{% endif %}
              {% endfor %}
            ]
          }{% if not loop.last %},{% endif %}
        {% endfor %}
      {% endif %}
    ]
  };

  // ====== Grund-Setup ======
  const map = new maplibregl.Map({
    container: 'map',
    style: 'https://tiles.joormann-media.de/styles/osm-bright/style.json',
    center: [6.6, 51.65],
    zoom: 10
  });

  // Persistente Zust√§nde
  let stops = [];
  let stopMarkers = [];
  let otherMarkers = [];
  let contextMenuEl = null;
  let gKids = [];
  let gSchool = null;
  let gStart = null;
  let gEnd = null;

  const ORS_BASE = "https://tiles.joormann-media.de/ors/";
  const NOM_BASE = "https://tiles.joormann-media.de";
  const channel = new BroadcastChannel("tour_map");

  map.on("load", () => {
    if (CONFIG.stops && CONFIG.stops.length > 0) {
      stops = CONFIG.stops.map(s => ({
        id: String(s.id),
        address: s.address,
        lng: s.lng,
        lat: s.lat,
        kids: s.kids || []
      }));
      renderStops();
    }

    gStart  = CONFIG.start;
    gEnd    = CONFIG.end;
    gSchool = CONFIG.school;

    renderOther();
    drawRoute(); // nur 1x
  });

  if (CONFIG.schoolId) {
    fetch(`/school-tour/school/${CONFIG.schoolId}/kids`)
      .then(res => res.json())
      .then(kids => { gKids = kids; renderOther(); })
      .catch(err => console.error("‚ùå Fehler beim Laden der Kids:", err));
  }

  function geojsonToGPX(geojson) {
    if (!geojson?.features?.length) return "";
    const coords = geojson.features[0].geometry.coordinates;
    const points = coords.map(c =>
      `<trkpt lon="${c[0]}" lat="${c[1]}"></trkpt>`
    ).join("\n    ");
    return `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="TourPlanner">
  <trk>
    <name>Geplante Route</name>
    <trkseg>
      ${points}
    </trkseg>
  </trk>
</gpx>`;
  }

  // ====== Route zeichnen ======
  async function drawRoute() {
    let geojson = null;

    // 1. Gespeicherte Route nur f√ºrs Rendering
    if (CONFIG.savedRoute) {
      let saved = CONFIG.savedRoute;
      if (typeof saved === "string") {
        try { saved = JSON.parse(saved); } catch(e) { saved = null; }
      }
      geojson = saved?.geojson || saved;

      if (geojson) {
        if (map.getSource("route")) {
          map.removeLayer("route");
          map.removeSource("route");
        }
        map.addSource("route", { type: "geojson", data: geojson });
        map.addLayer({
          id: "route",
          type: "line",
          source: "route",
          paint: { "line-color": "red", "line-width": 4 }
        });
        console.log("‚úÖ Saved route Linie angezeigt");
      }
    }

    // 2. ORS neu anwerfen f√ºr Distanz & Dauer
    const routeCoords = [];
    if (gStart?.lng && gStart?.lat) routeCoords.push([gStart.lng, gStart.lat]);
    stops.forEach(s => routeCoords.push([s.lng, s.lat]));
    const endLike = gEnd?.lng ? gEnd : gSchool;
    if (endLike?.lng && endLike?.lat) routeCoords.push([endLike.lng, endLike.lat]);

    if (routeCoords.length < 2) {
      document.getElementById("info").innerText = "‚ÑπÔ∏è Keine Route geladen";
      return;
    }

    try {
      const res = await fetch(`${ORS_BASE}v2/directions/driving-car/geojson`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ coordinates: routeCoords })
      });
      if (!res.ok) throw new Error(await res.text());
      const fresh = await res.json();

      if (map.getSource("route")) {
        map.removeLayer("route");
        map.removeSource("route");
      }
      map.addSource("route", { type: "geojson", data: fresh });
      map.addLayer({
        id: "route",
        type: "line",
        source: "route",
        paint: { "line-color": "red", "line-width": 4 }
      });

      // summary auslesen
    const summary = fresh.features[0].properties.summary;
    const km = (summary.distance / 1000).toFixed(1);
    const h = Math.floor(summary.duration / 3600);
    const m = Math.round((summary.duration % 3600) / 60);
    const timeStr = (h > 0 ? `${h}h ` : "") + `${m}min`;

    document.getElementById("info").innerText = `üõ£Ô∏è ${km} km | ‚è±Ô∏è ${timeStr}`;

    // Formularfelder synchronisieren (mit fixen IDs!)
    const distInput = document.getElementById("tour-distance");
    const durInput  = document.getElementById("tour-duration");

    if (distInput) {
      distInput.value = km;
      distInput.dispatchEvent(new Event("change", { bubbles: true }));
    }
    if (durInput) {
      durInput.value = Math.round(summary.duration);
      durInput.dispatchEvent(new Event("change", { bubbles: true }));
    }


      // GeoJSON + Stops ins Form syncen
      channel.postMessage({ updateRoute: { geojson: fresh, stops } });

      document.getElementById("route-json").textContent = JSON.stringify(fresh, null, 2);
      document.getElementById("route-gpx").textContent  = geojsonToGPX(fresh);

      console.log("üîÑ ORS-Route neu berechnet");
    } catch (err) {
      console.error("‚ùå ORS Fehler:", err);
    }
  }




  // === Modal f√ºr Kinder ===
  function openKidModal(kids, onConfirm) {
    const modal = document.getElementById("kid-modal");
    const list  = document.getElementById("kid-list");
    list.innerHTML = "";
    kids.forEach(k => {
      const div = document.createElement("div");
      div.innerHTML = `<label><input type="checkbox" value="${k.id}">${k.name} ‚Äì ${k.address}</label>`;
      list.appendChild(div);
    });
    modal.style.display = "block";
    document.getElementById("kid-cancel").onclick = () => modal.style.display = "none";
    document.getElementById("kid-assign").onclick = () => {
      const selectedIds = Array.from(list.querySelectorAll("input:checked")).map(cb => parseInt(cb.value));
      const selectedKids = kids.filter(k => selectedIds.includes(k.id));
      modal.style.display = "none"; onConfirm(selectedKids);
    };
  }

  // ====== Reverse Geocoding ======
  async function reverseDetails(lat, lon) {
    try {
      const res = await fetch(`${NOM_BASE}/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
      if (!res.ok) throw new Error(await res.text());
      const j = await res.json();
      const a = j.address || {};
      return {
        postcode: a.postcode || null,
        city: a.city || a.town || a.village || a.hamlet || null,
        street: a.road || a.pedestrian || a.footway || a.cycleway || null,
        housenumber: a.house_number || null,
        display_name: j.display_name || null
      };
    } catch (e) {
      console.warn("Reverse geocoding fehlgeschlagen:", e);
      return {};
    }
  }

  // ====== Context-Menu ======
  function showContextMenu(x, y, marker, stopData) {
    if (contextMenuEl) contextMenuEl.remove();
    const el = document.createElement("div");
    el.className = "context-popup";
    el.style.left = x + "px";
    el.style.top = y + "px";
    el.innerHTML = `
      <button id="ctx-add">‚ûï Als Haltepunkt √ºbernehmen</button>
      <button id="ctx-assign">üëß Kinder zuordnen</button>
      <button id="ctx-det">‚ÑπÔ∏è Details</button>
      <button id="ctx-del">üóëÔ∏è L√∂schen</button>
    `;
    document.body.appendChild(el);
    contextMenuEl = el;

    el.querySelector("#ctx-assign").onclick = async () => {
      try {
        let kids = [];
        if (!CONFIG.tourId) {
          kids = gKids.filter(k => !k.assigned);
        } else {
          const res = await fetch(`/school-tour/${CONFIG.tourId}/available-kids`);
          if (!res.ok) throw new Error(await res.text());
          kids = await res.json();
        }
        if (!kids || kids.length === 0) {
          alert("‚úÖ Alle Kinder haben schon Stops.");
          return;
        }
        openKidModal(kids, (selectedKids) => {
          if (selectedKids.length === 0) return;
          stopData.kids = stopData.kids || [];
          stopData.kids.push(...selectedKids);
          selectedKids.forEach(k => k.assigned = true);
          marker.setPopup(new maplibregl.Popup().setHTML(
            `<b>Stop</b><br>${stopData.address || ''}<br>` +
            `üëß ${stopData.kids.map(k => k.name).join(", ")}`
          ));
          if (CONFIG.tourId && stopData.id) {
            selectedKids.forEach(k => {
              fetch(`/school-tour/stop/${stopData.id}/assign/${k.id}`, { method: "POST" });
            });
          }
          channel.postMessage({ assignKidTemp: { stop: stopData, kids: selectedKids } });
        });
      } catch (err) {
        console.error("Fehler bei Kinderzuordnung:", err);
      }
      el.remove();
    };

    el.querySelector("#ctx-add").onclick = () => {
      if (!stops.includes(stopData)) {
        addStop(stopData.lng, stopData.lat, stopData.address || `Punkt (${stopData.lat.toFixed(5)}, ${stopData.lng.toFixed(5)})`);
      }
      el.remove();
    };

    el.querySelector("#ctx-det").onclick = async () => {
      const details = await reverseDetails(stopData.lat, stopData.lng);
      alert(
        `üìç Details:\n` +
        `Lng: ${stopData.lng}\nLat: ${stopData.lat}\n` +
        `Adresse: ${details.display_name || stopData.address || '‚Äì'}\n` +
        `PLZ: ${details.postcode || '‚Äì'} | Ort: ${details.city || '‚Äì'}\n` +
        `Stra√üe: ${details.street || '‚Äì'} ${details.housenumber || ''}`
      );
      el.remove();
    };

    el.querySelector("#ctx-del").onclick = () => {
      const idx = stops.indexOf(stopData);
      if (idx > -1) {
        stops.splice(idx, 1);
        renderStops();
        drawRoute();
        channel.postMessage({ removeStop: stopData });
      } else {
        marker.remove();
      }
      el.remove();
    };

    setTimeout(() => {
      const closer = (ev) => {
        if (!el.contains(ev.target)) {
          el.remove();
          document.removeEventListener("click", closer);
          contextMenuEl = null;
        }
      };
      document.addEventListener("click", closer);
    }, 0);
  }

  // ====== Stop-Marker interaktiv ======
  function makeInteractiveStopMarker(marker, stopData) {
  marker.setDraggable(true);

  marker.on("dragend", async () => {
    const { lng, lat } = marker.getLngLat();
    stopData.lng = lng;
    stopData.lat = lat;

    // Reverse Details ‚Üí Adresse aktualisieren
    const det = await reverseDetails(lat, lng);
    if (det.display_name) stopData.address = det.display_name;

    // Formularfelder sofort updaten
    const wrapper = document.querySelector(
      `#stops-wrapper [data-stop-id="${String(stopData.id)}"]`
    );
    if (wrapper) {
      const latInput  = wrapper.querySelector("[name$='[latitude]']");
      const lngInput  = wrapper.querySelector("[name$='[longitude]']");
      const addrInput = wrapper.querySelector("[name$='[address]']");
      if (latInput)  latInput.value  = stopData.lat.toFixed(6);
      if (lngInput)  lngInput.value  = stopData.lng.toFixed(6);
      if (addrInput) addrInput.value = stopData.address || "";
    } else {
      console.warn("‚ö†Ô∏è Kein Formular-Wrapper gefunden f√ºr Stop:", stopData.id);
    }
    syncStopsToForm();   // ‚¨ÖÔ∏è wichtig!
    // Route neu zeichnen + Broadcast
    drawRoute();
    channel.postMessage({ updateStop: stopData });

    console.log("üîÑ Stop verschoben:", stopData);
  });

  // Rechtsklick-Men√º
  marker.getElement().addEventListener("contextmenu", (e) => {
    e.preventDefault();
    showContextMenu(e.pageX, e.pageY, marker, stopData);
  });
}







  // ====== Stops rendern ======
  function renderStops() {
  stopMarkers.forEach(m => m.remove());
  stopMarkers = [];

  stops.forEach((s, idx) => {
    const marker = new maplibregl.Marker({ color: "yellow" })
      .setLngLat([s.lng, s.lat])
      .setPopup(new maplibregl.Popup().setHTML(`<b>Stop ${idx+1}</b><br>${s.address}`))
      .addTo(map);

    marker.__stopId = s.id;
    makeInteractiveStopMarker(marker, s);
    stopMarkers.push(marker);

    // Formular-Wrapper suchen und KORREKT markieren
    const wrapper = document.querySelector(
      `#stops-wrapper [data-stop-id="new-${idx+1}"], #stops-wrapper [data-stop-id="${s.id}"]`
    );
    if (wrapper) {
      wrapper.setAttribute("data-stop-id", String(s.id));
    }
  });

  syncStopsToForm();
}



function syncStopsToForm() {
  stops.forEach(s => {
    if (!s.id) return;
    const wrapper = document.querySelector(`#stops-wrapper [data-stop-id="${s.id}"]`);
    if (wrapper) {
      const latInput  = wrapper.querySelector("[name$='[latitude]']");
      const lngInput  = wrapper.querySelector("[name$='[longitude]']");
      const addrInput = wrapper.querySelector("[name$='[address]']");
      if (latInput)  latInput.value  = s.lat?.toFixed(6) || "";
      if (lngInput)  lngInput.value  = s.lng?.toFixed(6) || "";
      if (addrInput) addrInput.value = s.address || "";
    }
  });
}



  // ====== Externe Daten rendern (Kids gruppiert pro Adresse) ======
function renderOther() {
  otherMarkers.forEach(m => m.remove());
  otherMarkers = [];

  const groups = {};
  (gKids || []).forEach(k => {
    if (!k.lat || !k.lng) return;
    const key = `${k.lat.toFixed(6)},${k.lng.toFixed(6)}`;
    (groups[key] ||= []).push(k);
  });

  Object.values(groups).forEach(group => {
    const kid = group[0]; // Basis-Kind f√ºr Koordinaten
    const count = group.length;
    const popupHtml = `
      <b>${kid.address || 'Adresse'}</b><br>
      ${group.map(g => `‚Ä¢ ${g.name}`).join("<br>")}
    `;

    // Marker mit Zahl
    const el = document.createElement("div");
    el.style.background = "blue";
    el.style.color = "white";
    el.style.width = "26px";
    el.style.height = "26px";
    el.style.borderRadius = "50%";
    el.style.display = "flex";
    el.style.alignItems = "center";
    el.style.justifyContent = "center";
    el.style.fontSize = "13px";
    el.style.fontWeight = "bold";
    el.textContent = count;

    const popup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
      offset: 20
    }).setHTML(popupHtml);

    const m = new maplibregl.Marker({ element: el })
      .setLngLat([kid.lng, kid.lat])
      .addTo(map);

    // Popup bei Hover
    m.getElement().addEventListener("mouseenter", () => {
      popup.setLngLat([kid.lng, kid.lat]).addTo(map);
    });
    m.getElement().addEventListener("mouseleave", () => {
      popup.remove();
    });

    // Rechtsklick ‚Üí Kontextmen√º
    m.getElement().addEventListener("contextmenu", (e) => {
      e.preventDefault();
      const tmp = { lng: kid.lng, lat: kid.lat, address: kid.address || undefined };
      showContextMenu(e.pageX, e.pageY, m, tmp);
    });

    otherMarkers.push(m);
  });

    if (gStart?.lat && gStart?.lng) {
      const m = new maplibregl.Marker({ color: "darkgreen" })
        .setLngLat([gStart.lng, gStart.lat])
        .setPopup(new maplibregl.Popup().setHTML(`<b>Start:</b> ${gStart.address || ''}`))
        .addTo(map);
      otherMarkers.push(m);
    }

    if (gSchool?.lat && gSchool?.lng) {
      const m = new maplibregl.Marker({ color: "green" })
        .setLngLat([gSchool.lng, gSchool.lat])
        .setPopup(new maplibregl.Popup().setHTML(`<b>Schule:</b> ${gSchool.name || ''}<br>${gSchool.address || ''}`))
        .addTo(map);
      otherMarkers.push(m);
    }

    if (gEnd?.lat && gEnd?.lng) {
      const m = new maplibregl.Marker({ color: "red" })
        .setLngLat([gEnd.lng, gEnd.lat])
        .setPopup(new maplibregl.Popup().setHTML(`<b>Ziel:</b> ${gEnd.address || ''}`))
        .addTo(map);
      otherMarkers.push(m);
    }

    const all = [...stopMarkers, ...otherMarkers];
    if (all.length > 0) {
      const b = new maplibregl.LngLatBounds();
      all.forEach(m => b.extend(m.getLngLat()));
      map.fitBounds(b, { padding: 50, maxZoom: 16 });
    }
  }

  // ====== Stop hinzuf√ºgen ======
  function addStop(lng, lat, address) {
  const tmpId = "tmp-" + Date.now();
  const stop = { id: tmpId, lng, lat, address };
  stops.push(stop);
  renderStops();
  drawRoute();
  channel.postMessage({ addStop: stop });
  return stop;
}


  // ====== Klick in Karte ======
  // Linksklick ‚Üí Wegpunkt setzen
map.on("click", async (e) => {
  const { lng, lat } = e.lngLat;

  // Wegpunkt merken
  const waypoint = { lng, lat };
  if (!window.waypoints) window.waypoints = [];
  window.waypoints.push(waypoint);

  // Marker setzen (wei√üer Punkt)
  const markerEl = document.createElement("div");
  markerEl.style.width = "10px";
  markerEl.style.height = "10px";
  markerEl.style.borderRadius = "50%";
  markerEl.style.background = "white";
  markerEl.style.border = "2px solid black";

  new maplibregl.Marker({ element: markerEl })
    .setLngLat([lng, lat])
    .addTo(map);

  // Route neu zeichnen (inkl. Waypoints)
  drawRoute();
});

// Rechtsklick ‚Üí Kontextmen√º f√ºr Haltepunkte
map.on("contextmenu", async (e) => {
  e.preventDefault();
  const { lng, lat } = e.lngLat;
  const det = await reverseDetails(lat, lng);
  const address = det.display_name || `Punkt (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
  const stopData = { lng, lat, address };

  showContextMenu(e.originalEvent.pageX, e.originalEvent.pageY, null, stopData);
});


  // ====== Suche ======
  const input = document.getElementById("search-input");
  const results = document.getElementById("search-results");
  input.addEventListener("input", async () => {
    const q = input.value.trim();
    results.innerHTML = "";
    if (q.length < 3) return;
    try {
      const res = await fetch(`${NOM_BASE}/search?format=json&limit=6&q=${encodeURIComponent(q)}`);
      if (!res.ok) return;
      const list = await res.json();
      if (!Array.isArray(list) || list.length === 0) {
        results.innerHTML = "<div style='padding:6px;color:#888;'>Keine Treffer</div>";
        return;
      }
      list.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.display_name;
        btn.onclick = () => {
          results.innerHTML = "";
          const lng = parseFloat(item.lon), lat = parseFloat(item.lat);
          addStop(lng, lat, item.display_name);
          map.flyTo({ center: [lng, lat], zoom: 15 });
        };
        results.appendChild(btn);
      });
    } catch (e) {
      console.error("‚ùå Autocomplete Fehler:", e);
    }
  });

  // ====== BroadcastChannel ======
  channel.onmessage = (ev) => {
  const data = ev.data || {};

  if (data.focusStop) {
    const { id, lat, lng } = data.focusStop;
    if (lat && lng) {
      map.flyTo({ center: [lng, lat], zoom: 16 });
      console.log("üéØ Fokus auf Stop:", id);

      // passenden Marker suchen
      const marker = stopMarkers.find(m => String(m.__stopId) === String(id));
      if (marker) {
        // Popup √∂ffnen
        marker.togglePopup();

        // Highlight-Effekt
        const el = marker.getElement();
        el.style.transition = "transform 0.2s ease";
        el.style.transform = "scale(1.5)";
        setTimeout(() => { el.style.transform = "scale(1)"; }, 600);
      }
    }
    return; // ‚ö°Ô∏è Abbruch ‚Üí nicht weiter runter gehen
  }

  // alles andere
  if (Array.isArray(data.kids)) gKids = data.kids;
  gSchool = data.school || gSchool;
  gStart  = data.start  || gStart;
  gEnd    = data.end    || gEnd;

  renderOther();
  drawRoute();
};

</script>


</body>
</html>
