{{ form_start(form, {'attr': {'class': 'needs-validation', 'novalidate': true}}) }}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0 rounded-4 bg-light">
            <div class="card-body py-4">
                <div class="d-flex justify-content-between align-items-center">
                    <button class="btn btn-lg btn-primary px-5 rounded-pill shadow" type="submit">
                        üíæ Speichern & Durchstarten
                    </button>
                    <a href="{{ path('app_school_index') }}" class="btn btn-lg btn-outline-secondary rounded-pill">
                        ‚¨ÖÔ∏è Zur√ºck zur √úbersicht
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row g-4">
        <div class="col-12 col-lg-8">
            <div class="card shadow rounded-4 border-0 mb-4">
                <div class="card-header bg-primary text-white rounded-top-4">
                    <h4 class="mb-0">Schuldaten</h4>
                </div>
                <div class="card-body">

                    <div class="row g-3">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.name.vars.id }}" class="form-label">Name der Schule</label>
                            {{ form_widget(form.name, {'attr': {'class': 'form-control', 'placeholder': 'Name der Schule'}}) }}
                            {{ form_errors(form.name) }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.shorttag.vars.id }}" class="form-label">Kurztag</label>
                            {{ form_widget(form.shorttag, {'attr': {'class': 'form-control', 'placeholder': 'Kurztag'}}) }}
                            {{ form_errors(form.shorttag) }}
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.street.vars.id }}" class="form-label">Stra√üe</label>
                            {{ form_widget(form.street, {'attr': {'class': 'form-control', 'placeholder': 'Stra√üe'}}) }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.streetNo.vars.id }}" class="form-label">Hausnr.</label>
                            {{ form_widget(form.streetNo, {'attr': {'class': 'form-control', 'placeholder': 'Hausnr.'}}) }}
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.zip.vars.id }}" class="form-label">PLZ</label>
                            {{ form_widget(form.zip, {'attr': {'class': 'form-control', 'placeholder': 'PLZ'}}) }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.city.vars.id }}" class="form-label">Ort</label>
                            {{ form_widget(form.city, {'attr': {'class': 'form-control', 'placeholder': 'Ort'}}) }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.district.vars.id }}" class="form-label">Stadtteil</label>
                            {{ form_widget(form.district, {'attr': {'class': 'form-control', 'placeholder': 'Stadtteil'}}) }}
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.phone.vars.id }}" class="form-label">Telefon</label>
                            {{ form_widget(form.phone, {'attr': {'class': 'form-control', 'placeholder': 'Telefon'}}) }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email.vars.id }}" class="form-label">E-Mail</label>
                            {{ form_widget(form.email, {'attr': {'class': 'form-control', 'placeholder': 'E-Mail'}}) }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.contactPerson.vars.id }}" class="form-label">Kontaktperson</label>
                        {{ form_widget(form.contactPerson, {'attr': {'class': 'form-select'}}) }}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.additionalInfo.vars.id }}" class="form-label">Zus√§tzliche Infos</label>
                        {{ form_widget(form.additionalInfo, {'attr': {'class': 'form-control', 'rows': 4, 'placeholder': 'Was noch wichtig ist...'}}) }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card shadow rounded-4 border-0 mb-4">
                <div class="card-header bg-secondary text-white rounded-top-4">
                    <h4 class="mb-0">Geodaten & Adresse</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold mb-1" for="{{ form.address.vars.id }}">Verkn√ºpfte Adresse (DB)</label>
                        {{ form_widget(form.address, {'attr': {
                            'class': 'form-select select2-async w-100',
                            'data-placeholder': 'Adresse suchen...'
                        }}) }}
                        <div class="form-text">
                            <span class="text-warning">Tipp:</span> Adresse per Autocomplete suchen, dann ausw√§hlen!
                        </div>
                        {{ form_errors(form.address) }}
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.latitude.vars.id }}" class="form-label">Breitengrad (Lat.)</label>
                            {{ form_widget(form.latitude, {'attr': {'class': 'form-control', 'placeholder': 'Latitude', 'step': 'any'}}) }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.longitude.vars.id }}" class="form-label">L√§ngengrad (Lon.)</label>
                            {{ form_widget(form.longitude, {'attr': {'class': 'form-control', 'placeholder': 'Longitude', 'step': 'any'}}) }}
                        </div>
                    </div>
                    <div>
                        <label class="form-label fw-bold mb-1">Kartenansicht</label>
                        <div id="leaflet-map" class="rounded-4 shadow-sm border mb-2" style="height: 280px;"></div>
                        <div class="small text-muted mb-0">
                            Pin zeigt die aktuell gew√§hlte Adresse oder Koordinaten.<br>
                            <span id="map-coords"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

{{ form_end(form) }}

{# ‚Äî‚Äî‚Äî SCRIPTS: Select2 & Leaflet ‚Äî‚Äî‚Äî #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
$(function() {
    // --- Init Select2 (Adresse) ---
    $('.select2-async').select2({
        placeholder: $('.select2-async').data('placeholder') || 'Adresse suchen ...',
        allowClear: true,
        minimumInputLength: 3,
        width: '100%',
        ajax: {
            url: "{{ path('api_address_suggest') }}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return { q: params.term };
            },
            processResults: function (data) {
                return { results: data.results || data };
            },
            cache: true
        }
    });

    // --- Leaflet-Map ---
    // Startwerte NRW-Mitte
    let startLat = $('#{{ form.latitude.vars.id }}').val() || 51.55;
    let startLon = $('#{{ form.longitude.vars.id }}').val() || 6.75;

    const map = L.map('leaflet-map').setView([startLat, startLon], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap-Mitwirkende'
    }).addTo(map);

    let marker = L.marker([startLat, startLon], {draggable: false}).addTo(map);

    function showCoords(lat, lon) {
        $('#map-coords').text('Breitengrad: ' + lat + ', L√§ngengrad: ' + lon);
    }
    function updateMap(lat, lon) {
        if (!lat || !lon) return;
        marker.setLatLng([parseFloat(lat), parseFloat(lon)]);
        map.setView([parseFloat(lat), parseFloat(lon)], 15);
        showCoords(lat, lon);
    }

    // Initialwerte anzeigen, falls da
    if (startLat && startLon) {
        updateMap(startLat, startLon);
    }

    // Bei Auswahl Adresse ‚Üí hole Koordinaten und aktualisiere Map
    $('.select2-async').on('select2:select', function(e) {
        let data = e.params.data;
        if (data.lat && data.lon) {
            $('#{{ form.latitude.vars.id }}').val(data.lat).trigger('input');
            $('#{{ form.longitude.vars.id }}').val(data.lon).trigger('input');
            updateMap(data.lat, data.lon);
        } else if (data.id) {
            // Optional: Hole Koordinaten per AJAX von /api/official-address/{id}
            $.get('/api/official-address/' + data.id, function(addr) {
                if (addr.latitude && addr.longitude) {
                    $('#{{ form.latitude.vars.id }}').val(addr.latitude).trigger('input');
                    $('#{{ form.longitude.vars.id }}').val(addr.longitude).trigger('input');
                    updateMap(addr.latitude, addr.longitude);
                }
            });
        }
    });

    // Wenn Koordinaten manuell ge√§ndert werden, aktualisiere Map live
    $('#{{ form.latitude.vars.id }}, #{{ form.longitude.vars.id }}').on('input', function() {
        let lat = $('#{{ form.latitude.vars.id }}').val();
        let lon = $('#{{ form.longitude.vars.id }}').val();
        if (lat && lon) updateMap(lat, lon);
    });
});
</script>
