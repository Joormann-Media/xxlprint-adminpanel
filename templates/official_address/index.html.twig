{% extends 'base.html.twig' %}

{% block title %}ðŸ“® Adressverzeichnis{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="mb-3">ðŸ“¦ Adressverzeichnis</h1>

    <div class="bg-light p-3 rounded mb-4 border">
        <div class="text-muted mt-2">
            Seite {{ pagination.currentPage }} von {{ pagination.nbPages }} ({{ pagination.nbResults }} EintrÃ¤ge)
        </div>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <form method="get" id="address-search-form" class="d-flex flex-grow-1 gap-2 align-items-center position-relative">
    <input type="text"
           name="search"
           id="address-search-input"
           value="{{ app.request.get('search') }}"
           class="form-control"
           autocomplete="off"
           placeholder="ðŸ” Suche (egal was, z.â€¯B. 62 BlÃ¼tenstr Wesel)">
    <div class="d-flex gap-1 align-items-center ms-2">
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="fields[]" value="postcode" id="fieldPostcode" checked>
            <label class="form-check-label" for="fieldPostcode">PLZ</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="fields[]" value="city" id="fieldCity" checked>
            <label class="form-check-label" for="fieldCity">Stadt</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="fields[]" value="street" id="fieldStreet" checked>
            <label class="form-check-label" for="fieldStreet">StraÃŸe</label>
        </div>
    </div>
    <button type="submit" class="btn btn-primary ms-2">Suchen</button>
    <a href="{{ path(app.request.attributes.get('_route')) }}" class="btn btn-outline-secondary ms-2">ZurÃ¼cksetzen</a>
</form>


            <div class="text-end d-flex flex-wrap gap-2 justify-content-end">
                <a href="{{ path('app_official_address_import') }}" class="btn btn-warning">ðŸ“¥ Adressen importieren</a>
                <a href="{{ path('app_official_address_new') }}" class="btn btn-success">âž• Neue Adresse anlegen</a>
            </div>
        </div>
    </div>

    <div id="address-table-container">
        {% include 'official_address/__table.html.twig' %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('address-search-form');
    const input = document.getElementById('address-search-input');
    const containerId = 'address-table-container';
    const container = document.getElementById(containerId);
    let debounceTimer = null;

    function getSearchUrl() {
        const url = new URL(window.location.href.split('?')[0]);
        const formData = new FormData(form);
        for (const [key, value] of formData.entries()) {
            url.searchParams.append(key, value);
        }
        url.searchParams.set('ajax', '1'); // Marker fÃ¼r Backend, falls nÃ¶tig
        return url.toString();
    }

    function loadTable(url) {
        if (!container) return;
        container.innerHTML = `
            <div class="text-center my-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Lade...</span>
                </div>
            </div>`;

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.querySelector(`#${containerId}`);
                if (newContent) {
                    container.innerHTML = newContent.innerHTML;
                    history.replaceState({}, '', url); // Kein Push, sondern Replace!
                } else {
                    container.innerHTML = `<div class="alert alert-danger">Fehler beim Laden der Tabelle</div>`;
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Tabelle:', error);
                container.innerHTML = `<div class="alert alert-danger">Fehler beim Laden der Tabelle</div>`;
            });
    }

    // Live-Suche beim Tippen (mit debounce)
    input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const url = getSearchUrl();
            loadTable(url);
        }, 300);
    });

    // Checkbox-Filter triggern ebenfalls Live-Suche
    form.querySelectorAll('.form-check-input').forEach(cb => {
        cb.addEventListener('change', () => {
            const url = getSearchUrl();
            loadTable(url);
        });
    });

    // Klassischer Submit via Button (Formular)
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const url = getSearchUrl();
        loadTable(url);
    });

    // Sortierung und Pagination abfangen
    document.body.addEventListener('click', (e) => {
        const sortLink = e.target.closest('.sort-link');
        if (sortLink) {
            e.preventDefault();
            const url = new URL(sortLink.href);
            loadTable(url.toString());
        }
        const pageLink = e.target.closest('.page-link');
        if (pageLink && pageLink.href) {
            e.preventDefault();
            loadTable(pageLink.href);
        }
    });
});
</script>


{% endblock %}
