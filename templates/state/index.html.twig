{% extends 'base.html.twig' %}

{% block title %}üåç Bundesl√§nder √úbersicht{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        .mini-map {
            width: 180px;
            height: 120px;
            border-radius: .5rem;
            border: 1px solid #dee2e6;
            background: #e9ecef;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h1 class="mb-0">üåç Bundesl√§nder <small class="text-muted fs-6">({{ states|length }})</small></h1>
        <a href="{{ path('app_state_new') }}" class="btn btn-success">‚ûï Neues Bundesland</a>
    </div>

    <div class="table-responsive">
        <table class="table align-middle table-striped shadow-sm rounded">
            <thead class="table-primary">
                <tr>
                    <th>ID</th>
                    <th>K√ºrzel</th>
                    <th>Name</th>
                    <th>Lat/Lon</th>
                    <th>Polygon</th>
                    <th>Aktionen</th>
                </tr>
            </thead>
            <tbody>
            {% for state in states %}
                <tr>
                    <td>{{ state.id }}</td>
                    <td><span class="badge bg-primary">{{ state.code }}</span></td>
                    <td>{{ state.name }}</td>
                    <td>
                        {{ state.latitude|number_format(4, '.', '') }},
                        {{ state.longitude|number_format(4, '.', '') }}
                    </td>
                    <td>
                        {% if state.polygon %}
                            <div id="mini-map-{{ state.id }}" class="mini-map" style="width:400px; height:250px; border:2px solid red;" data-lat="{{ state.latitude }}" data-lon="{{ state.longitude }}"></div>

                            <script type="application/json" id="polygon-{{ state.id }}">
                                {{ state.polygon|json_encode(constant('JSON_UNESCAPED_UNICODE'))|raw }}
                            </script>
                        {% else %}
                            <span class="text-muted fst-italic">Kein Polygon</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ path('app_state_show', {'id': state.id}) }}" class="btn btn-sm btn-outline-secondary">Anzeigen</a>
                        <a href="{{ path('app_state_edit', {'id': state.id}) }}" class="btn btn-sm btn-outline-primary">Bearbeiten</a>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-5">Keine Bundesl√§nder gefunden.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.mini-map').forEach(function(el) {
                var lat = parseFloat(el.dataset.lat);
                var lon = parseFloat(el.dataset.lon);
                var id = el.id.replace('mini-map-', '');
                var polygonEl = document.getElementById('polygon-' + id);
                var polygon = null;
                if (polygonEl) {
                    try {
                        polygon = JSON.parse(polygonEl.textContent);
                    } catch (e) {
                        console.warn("Polygon konnte nicht geparst werden f√ºr ID " + id, e);
                    }
                }

                // Testausgabe
                console.log("MiniMap f√ºr ID", id, polygon);

                var map = L.map(el, {
                    center: [lat, lon],
                    zoom: 6,
                    dragging: false,
                    zoomControl: false,
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    boxZoom: false,
                    keyboard: false,
                    attributionControl: false,
                    tap: false,
                    touchZoom: false,
                    interactive: false
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    minZoom: 5, maxZoom: 8
                }).addTo(map);

                if (polygon) {
                    // Draw GeoJSON and store as layer
                    var layer = L.geoJSON(polygon, {
                        style: {color:'#d33', fillColor:'#fc0', fillOpacity:0.4, weight:2}
                    }).addTo(map);

                    // fitBounds: Test mit Delay
                    setTimeout(function() {
                        try {
                            var bounds = layer.getBounds();
                            if (bounds.isValid()) {
                                map.fitBounds(bounds, {padding: [2,2]});
                                // Test: Marker auf Mittelpunkt (soll sichtbar sein!)
                                var marker = L.circleMarker([lat, lon], {radius:2, color:'#00f'}).addTo(map);
                            } else {
                                console.warn("Bounds invalid f√ºr " + id, bounds);
                            }
                        } catch (e) {
                            console.warn('fitBounds failed for', id, e);
                        }
                    }, 300);
                } else {
                    el.innerHTML = '<span style="color:red;">Kein Polygon geladen</span>';
                }
            });
        });
    </script>
{% endblock %}
