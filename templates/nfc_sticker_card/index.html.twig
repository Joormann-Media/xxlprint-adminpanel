{% extends 'base.html.twig' %}

{% block title %}NFC-Sticker & Karten{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h2 class="mb-0">NFC-Sticker & Karten</h2>
        <a href="{{ path('app_nfc_sticker_card_new') }}" class="btn btn-success">âž• Neuen Sticker/Karte anlegen</a>
    </div>
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" id="nfcSearch" class="form-control" placeholder="ðŸ” Suche...">
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0" id="nfcTable" style="min-width: 1200px;">
<thead class="table-light sticky-top">
    <tr>
        <th class="sortable">UID</th>
        <th class="sortable">Typ</th>
        <th class="sortable">Label</th>
        <th class="sortable">Zweck</th>
        <th class="sortable">Ziel</th>
        <th class="sortable">User</th>
        <th class="sortable">Status</th>
        <th class="sortable">Ausgegeben</th>
        <th class="sortable">Letzter Scan</th>
        <th class="sortable">Kommentar</th>
        <th class="sortable">Erstellt</th>
        <th class="sortable">GeÃ¤ndert</th>
        <th class="text-center">Aktionen</th>
    </tr>
</thead>
<tbody>
    {% for nfc in nfc_sticker_cards %}
        <tr>
            <td><code>{{ nfc.uid }}</code></td>
            <td>{{ nfc.type|capitalize }}</td>
            <td>{{ nfc.label|default('â€”') }}</td>
            <td>{{ nfc.purpose|default('â€”') }}</td>
            <td>{{ nfc.target|default('â€”') }}</td>
            <td>
                {% if nfc.user %}
                    <span title="User-ID: {{ nfc.user.id }}">{{ nfc.user.username|default(nfc.user.email) }}</span>
                {% else %}
                    <span class="text-muted">â€”</span>
                {% endif %}
            </td>
            <td>
                {% if nfc.active %}
                    <span class="badge bg-success">Aktiv</span>
                {% else %}
                    <span class="badge bg-secondary">Inaktiv</span>
                {% endif %}
            </td>
            <td>{{ nfc.issuedAt ? nfc.issuedAt|date('Y-m-d') : 'â€”' }}</td>
            <td>{{ nfc.lastScanAt ? nfc.lastScanAt|date('Y-m-d H:i') : 'â€”' }}</td>
            <td>
                {{ nfc.comment|length > 32 ? nfc.comment|slice(0,32) ~ 'â€¦' : nfc.comment|default('â€”') }}
            </td>
            <td>{{ nfc.createdAt ? nfc.createdAt|date('Y-m-d') : 'â€”' }}</td>
            <td>{{ nfc.updatedAt ? nfc.updatedAt|date('Y-m-d') : 'â€”' }}</td>
            <td class="text-center">
                <a href="{{ path('app_nfc_sticker_card_show', {'id': nfc.id}) }}" class="btn btn-sm btn-outline-info" title="Anzeigen"><i class="bi bi-eye"></i></a>
                <a href="{{ path('app_nfc_sticker_card_edit', {'id': nfc.id}) }}" class="btn btn-sm btn-outline-primary ms-1" title="Bearbeiten"><i class="bi bi-pencil"></i></a>
            </td>
        </tr>
    {% else %}
        <tr>
            <td colspan="13" class="text-center text-muted">Keine Sticker/Karten gefunden.</td>
        </tr>
    {% endfor %}
</tbody>
</table>
</div>
</div>
</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Suche
    const searchInput = document.getElementById('nfcSearch');
    searchInput.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        document.querySelectorAll("#nfcTable tbody tr").forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(value) ? '' : 'none';
        });
    });

    // Sortierung
    function compareRows(a, b, idx, asc, isNumber) {
        let v1 = a.children[idx].innerText.trim();
        let v2 = b.children[idx].innerText.trim();
        if (isNumber) {
            v1 = parseFloat(v1.replace(/[^0-9.\-]/g, "")) || 0;
            v2 = parseFloat(v2.replace(/[^0-9.\-]/g, "")) || 0;
        }
        return asc
            ? (v1.localeCompare ? v1.localeCompare(v2, undefined, {numeric:isNumber}) : (v1 > v2 ? 1 : -1))
            : (v2.localeCompare ? v2.localeCompare(v1, undefined, {numeric:isNumber}) : (v1 > v2 ? 1 : -1));
    }

    document.querySelectorAll('#nfcTable th.sortable').forEach((th, idx) => {
        th.style.cursor = "pointer";
        th.insertAdjacentHTML('beforeend', ' <span class="sort-arrow">â‡…</span>');
        let asc = true;
        th.addEventListener('click', function() {
            document.querySelectorAll('#nfcTable th .sort-arrow').forEach(el => el.textContent = 'â‡…');
            th.querySelector('.sort-arrow').textContent = asc ? 'â†‘' : 'â†“';

            const tbody = th.closest('table').querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => tr.style.display !== "none");
            // Hier ggf. Indexe fÃ¼r Zahlen anpassen (z.B. SitzplÃ¤tze)
            const isNumber = []; // FÃ¼r Felder wie "Sitze" z.B. [6]
            rows.sort((a, b) => compareRows(a, b, idx, asc, isNumber));
            rows.forEach(tr => tbody.appendChild(tr));
            asc = !asc;
        });
    });

    // Optional: Simple Pagination (20 Zeilen pro Seite)
    const rowsPerPage = 20;
    const table = document.getElementById('nfcTable');
    const tbody = table.querySelector('tbody');
    let allRows = Array.from(tbody.querySelectorAll('tr'));
    let currentPage = 1;

    function showPage(page) {
        let start = (page-1)*rowsPerPage;
        let end = start + rowsPerPage;
        allRows.forEach((tr, idx) => {
            tr.style.display = (idx >= start && idx < end) ? '' : 'none';
        });
        document.getElementById('nfcTablePageInfo').textContent = `Seite ${currentPage} / ${Math.ceil(allRows.length/rowsPerPage)}`;
    }

    if (allRows.length > rowsPerPage) {
        // Paginierungs-UI
        let pager = document.createElement('div');
        pager.className = 'd-flex justify-content-end align-items-center gap-2 mt-2 mb-3';
        pager.innerHTML = `
            <button class="btn btn-outline-secondary btn-sm" id="nfcTablePrev">&laquo;</button>
            <span id="nfcTablePageInfo"></span>
            <button class="btn btn-outline-secondary btn-sm" id="nfcTableNext">&raquo;</button>
        `;
        table.parentNode.insertBefore(pager, table);

        document.getElementById('nfcTablePrev').onclick = function() {
            if (currentPage > 1) { currentPage--; showPage(currentPage); }
        };
        document.getElementById('nfcTableNext').onclick = function() {
            if (currentPage < Math.ceil(allRows.length/rowsPerPage)) { currentPage++; showPage(currentPage); }
        };
        showPage(1);
    }
});
</script>
{% endblock %}
