{% extends 'base.html.twig' %}


{% block body %}
<h1 class="mb-4">âœï¸ Shortcode-Image bearbeiten</h1>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        {{ include('shortcode_image/_form.html.twig', { form: form, button_label: 'Update' }) }}
    </div>
</div>

<h5 class="mb-2">ğŸ¨ Icon auswÃ¤hlen</h5>
<div id="iconPicker" class="d-flex flex-wrap gap-2 mb-4" style="border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
    {% for icon in icons %}
        <img src="{{ icon.url }}"
             alt="{{ icon.filename }}"
             data-filename="{{ icon.filename }}"
             class="icon-thumb border rounded p-1 {% if shortcode_image.filename == icon.filename %}border-primary{% endif %}"
             style="height: 32px; cursor: pointer;" />
    {% else %}
        <div class="text-muted">Keine Icons gefunden im Ordner <code>/public/gfx/shortcode/</code></div>
    {% endfor %}
</div>

<h4 class="mt-4">ğŸ§ª Vorschau</h4>
<div id="shortcode-preview" class="border p-3 rounded bg-light mb-3 text-center shadow-sm">
    {{ previewHtml|default('Noch keine Vorschau')|raw }}
</div>

<h4>ğŸ“‹ Copy & Paste Shortcode</h4>
<div class="input-group mb-4">
    <input type="text" class="form-control" id="shortcodeCopy"
           value='[[shortcode_image tag="{{ shortcode_image.tag }}"]]' readonly>
    <button class="btn btn-outline-secondary" type="button"
            onclick="navigator.clipboard.writeText(document.getElementById('shortcodeCopy').value)">
        ğŸ“‹ Kopieren
    </button>
</div>

<h5 class="mt-4">ğŸ“œ Twig-Einbindung</h5>
<pre><code>{{ "{{ '[[shortcode_image tag=\"" ~ shortcode_image.tag ~ "\"]]' | shortcode | raw }}" }}</code></pre>

<a href="{{ path('app_shortcode_image_index') }}" class="btn btn-secondary mt-4 me-2">â¬…ï¸ ZurÃ¼ck zur Ãœbersicht</a>
{{ include('shortcode_image/_delete_form.html.twig') }}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tagField = document.querySelector('#shortcode_image_tag');
    const filenameField = document.querySelector('#shortcode_image_filename');
    const pathField = document.querySelector('#shortcode_image_path');
    const titleField = document.querySelector('#shortcode_image_title');
    const descriptionField = document.querySelector('#shortcode_image_description');
    const previewBox = document.getElementById('shortcode-preview');
    const shortcodeField = document.getElementById('shortcodeCopy');

    // ICON-PICKER Funktion
    document.querySelectorAll('.icon-thumb').forEach(img => {
        img.addEventListener('click', () => {
            document.querySelectorAll('.icon-thumb').forEach(i => i.classList.remove('border-primary'));
            img.classList.add('border-primary');
            const iconName = img.getAttribute('data-filename');
            filenameField.value = iconName;
            updatePreview();
        });
    });

    const updatePreview = () => {
        const tag = tagField?.value ?? '';
        const filename = filenameField?.value ?? '';
        const path = pathField?.value ?? '';
        const title = titleField?.value ?? '';
        const description = descriptionField?.value ?? '';

        if (tag.trim() !== '') {
            shortcodeField.value = '[[shortcode_image tag="' + tag + '"]]';
        } else {
            shortcodeField.value = '';
        }

        const formData = new FormData();
        formData.append('tag', tag);
        formData.append('filename', filename);
        formData.append('path', path);
        formData.append('title', title);
        formData.append('description', description);

        fetch('{{ path("app_shortcode_image_preview") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            previewBox.innerHTML = html;
        })
        .catch(() => {
            previewBox.innerHTML = '<div class="text-danger">âŒ Vorschau konnte nicht geladen werden</div>';
        });
    };

    // Init + Events
    updatePreview();

    [tagField, filenameField, pathField, titleField, descriptionField].forEach(el => {
        if (el) {
            el.addEventListener('input', updatePreview);
        }
    });
});
</script>
{% endblock %}
