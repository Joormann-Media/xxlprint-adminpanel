{% extends 'base.html.twig' %}


{% block body %}
<h1 class="mb-4">ğŸ–¼ï¸ Neues Shortcode-Image erstellen</h1>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        {{ include('shortcode_image/_form.html.twig', { form: form }) }}
    </div>
</div>

<h5 class="mt-4">ğŸ¨ Icon-Galerie</h5>
<p>WÃ¤hle ein Icon aus, das als Bild angezeigt werden soll:</p>
<div id="iconSelector" class="d-flex flex-wrap gap-2 mb-4" style="border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
    {% for icon in icons %}
        <img src="{{ icon.url }}" alt="{{ icon.filename }}"
             data-filename="{{ icon.filename }}"
             class="icon-thumb border rounded p-1"
             style="height: 48px; cursor: pointer; border: 1px solid transparent;">
    {% else %}
        <div class="text-muted">âš ï¸ Keine Icons gefunden im Ordner <code>/public/gfx/shortcode/</code></div>
    {% endfor %}
</div>

<h4 class="mt-4 mb-2">ğŸ§ª Vorschau</h4>
<div id="shortcode-preview"
     class="border p-3 rounded bg-light text-center mb-3 shadow-sm">
    {% if previewHtml is not empty %}
        {{ previewHtml|raw }}
    {% else %}
        <span class="text-muted">Noch keine Vorschau...</span>
    {% endif %}
</div>

<div class="mb-4">
    <label for="shortcodePreviewText" class="form-label fw-semibold">ğŸ”— Dein Shortcode</label>
    <div class="input-group">
        <input type="text"
               class="form-control"
               id="shortcodePreviewText"
               value='[[shortcode_image tag="{{ shortcode_image.tag }}"]]'
               readonly>
        <button class="btn btn-outline-secondary"
                type="button"
                onclick="navigator.clipboard.writeText(document.getElementById('shortcodePreviewText').value)">
            ğŸ“‹ Kopieren
        </button>
    </div>
</div>

<div class="mb-4">
    <label for="shortcodeTwigDisplay" class="form-label">ğŸ“œ Twig-Code fÃ¼r dein Template</label>
    <pre><code id="shortcodeTwigDisplay">{{ "{{ '[[shortcode_image tag=\"" ~ shortcode_image.tag ~ "\"]]' | shortcode | raw }}" }}</code></pre>
</div>

<a href="{{ path('app_shortcode_image_index') }}" class="btn btn-secondary mb-4">â¬…ï¸ ZurÃ¼ck zur Ãœbersicht</a>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tagField = document.querySelector('#shortcode_image_tag');
    const filenameField = document.querySelector('#shortcode_image_filename');
    const pathField = document.querySelector('#shortcode_image_path');
    const titleField = document.querySelector('#shortcode_image_title');
    const descriptionField = document.querySelector('#shortcode_image_description');

    const shortcodeField = document.querySelector('#shortcodePreviewText');
    const twigCodeDisplay = document.querySelector('#shortcodeTwigDisplay');
    const previewBox = document.querySelector('#shortcode-preview');

    const updatePreview = () => {
        const tag = tagField?.value?.trim() ?? '';
        const filename = filenameField?.value ?? '';
        const path = pathField?.value ?? '';
        const title = titleField?.value ?? '';
        const description = descriptionField?.value ?? '';

        if (tag !== '') {
            shortcodeField.value = '[[shortcode_image tag="' + tag + '"]]';
            twigCodeDisplay.textContent = "{{ '{{ ' }}[[shortcode_image tag=\"" + tag + "\"]]{{ ' | shortcode | raw }}' }}";
        } else {
            shortcodeField.value = '';
            twigCodeDisplay.textContent = "{{ '[[shortcode_image tag=\"...\"]]' | shortcode | raw }}";
        }

        const formData = new FormData();
        formData.append('tag', tag);
        formData.append('filename', filename);
        formData.append('path', path);
        formData.append('title', title);
        formData.append('description', description);

        fetch('{{ path("app_shortcode_image_preview") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(html => {
            previewBox.innerHTML = html;
        })
        .catch(() => {
            previewBox.innerHTML = '<div class="text-danger">âŒ Vorschau konnte nicht geladen werden</div>';
        });
    };

    // Icon-Klick â†’ setze filename + update preview
    document.querySelectorAll('.icon-thumb').forEach(icon => {
        icon.addEventListener('click', function () {
            document.querySelectorAll('.icon-thumb').forEach(i => i.style.border = '1px solid transparent');
            this.style.border = '2px solid #007bff';
            filenameField.value = this.dataset.filename;
            updatePreview();
        });
    });

    // Inputs updaten die Vorschau
    ['#shortcode_image_tag', '#shortcode_image_filename', '#shortcode_image_path', '#shortcode_image_title', '#shortcode_image_description']
        .forEach(selector => {
            const el = document.querySelector(selector);
            if (el) {
                el.addEventListener('input', updatePreview);
            }
        });

    updatePreview();
});
</script>
{% endblock %}
