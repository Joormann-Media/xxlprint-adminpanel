{% extends 'base.html.twig' %}

{% block title %}ðŸ‘¦ðŸ‘§ Schulkinder{% endblock %}

{% block body %}
{% set sort = sort|default('lastName') %}
{% set direction = direction|default('ASC') %}
{% set route = route|default(app.request.attributes.get('_route')) %}
{% set query = query|default({}) %}

<div class="container mt-4">
    <h1 class="mb-3">ðŸ‘¦ðŸ‘§ Schulkinder</h1>
    <div class="bg-light p-3 rounded mb-4 border">
        <div class="text-muted mt-2">
            Seite {{ pagination.currentPage }} von {{ pagination.nbPages }} ({{ pagination.nbResults }} EintrÃ¤ge)
        </div>
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <form method="get" id="schoolkids-search-form" class="d-flex flex-grow-1 gap-2 align-items-center position-relative">
                <input type="text"
                       name="search"
                       id="schoolkids-search-input"
                       value="{{ app.request.get('search') }}"
                       class="form-control"
                       autocomplete="off"
                       placeholder="ðŸ” Suche (Name, Schule, Adresseâ€¦)">
                <div class="d-flex gap-1 align-items-center ms-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="fields[]" value="lastName" id="fieldLastName" checked>
                        <label class="form-check-label" for="fieldLastName">Nachname</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="fields[]" value="firstName" id="fieldFirstName" checked>
                        <label class="form-check-label" for="fieldFirstName">Vorname</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="fields[]" value="school" id="fieldSchool" checked>
                        <label class="form-check-label" for="fieldSchool">Schule</label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary ms-2">Suchen</button>
                <a href="{{ path(app.request.attributes.get('_route')) }}" class="btn btn-outline-secondary ms-2">ZurÃ¼cksetzen</a>
            </form>
            <div class="text-end d-flex flex-wrap gap-2 justify-content-end">
                <a href="{{ path('app_schoolkids_new') }}" class="btn btn-success">âž• Neues Schulkind</a>
                
            </div>
        </div>
    </div>
    <div id="schoolkids-table-container">
        {# Die Tabelle wird hier eingebunden (AJAX oder Full-Reload) #}
        {% include 'schoolkids/_table.html.twig' %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('schoolkids-search-form');
    const input = document.getElementById('schoolkids-search-input');
    const containerId = 'schoolkids-table-container';
    const container = document.getElementById(containerId);
    let debounceTimer = null;

    input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const url = getSearchUrl();
            loadTable(url);
        }, 300);
    });

    form.querySelectorAll('.form-check-input').forEach(cb => {
        cb.addEventListener('change', () => {
            const url = getSearchUrl();
            loadTable(url);
        });
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const url = getSearchUrl();
        loadTable(url);
    });

    document.body.addEventListener('click', (e) => {
        const sortLink = e.target.closest('.sort-link');
        if (sortLink) {
            e.preventDefault();
            loadTable(sortLink.href);
        }
        const pageLink = e.target.closest('.page-link');
        if (pageLink && pageLink.href) {
            e.preventDefault();
            loadTable(pageLink.href);
        }
    });

    function getSearchUrl() {
        const url = new URL(window.location.href.split('?')[0]);
        const formData = new FormData(form);
        for (const [key, value] of formData.entries()) {
            url.searchParams.append(key, value);
        }
        url.searchParams.set('ajax', '1');
        return url.toString();
    }

    function loadTable(url) {
        if (!container) return;
        container.innerHTML = `
            <div class="text-center my-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Lade...</span>
                </div>
            </div>`;

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.querySelector(`#${containerId}`);
                if (newContent) {
                    container.innerHTML = newContent.innerHTML;
                    history.replaceState({}, '', url);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">Fehler beim Laden der Tabelle</div>`;
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Tabelle:', error);
                container.innerHTML = `<div class="alert alert-danger">Fehler beim Laden der Tabelle</div>`;
            });
    }
});
</script>
{% endblock %}
