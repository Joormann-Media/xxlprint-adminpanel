{% extends 'base.html.twig' %}

{% block title %}Mitarbeiter√ºbersicht{% endblock %}

{% block body %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h1 class="mb-0">üë• Mitarbeiter√ºbersicht</h1>
        <a href="{{ path('app_employee_new') }}" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Neuer Mitarbeiter
        </a>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <form method="get" id="employee-search-form" class="d-flex gap-2">
                        <input type="text" name="search" id="employeeSearch" class="form-control" value="{{ search|default('') }}" placeholder="üîç Suche Mitarbeiter...">
                        <button type="submit" class="btn btn-primary">Suchen</button>
                        <a href="{{ path(app.request.attributes.get('_route')) }}" class="btn btn-outline-secondary">Zur√ºcksetzen</a>
                    </form>
                </div>
            </div>
            <div id="employee-table-container">
                {% include 'employee/_table.html.twig' %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('employee-search-form');
    const input = document.getElementById('employeeSearch');
    const containerId = 'employee-table-container';
    const container = document.getElementById(containerId);
    let debounceTimer = null;

    // Live-Suche (optional, oder einfach Enter dr√ºcken)
    input.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const url = getSearchUrl();
            loadTable(url);
        }, 300);
    });

    // Form Submit (Suchen)
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const url = getSearchUrl();
        loadTable(url);
    });

    // Sortierung & Pagination
    document.body.addEventListener('click', (e) => {
        const sortLink = e.target.closest('.sort-link');
        if (sortLink) {
            e.preventDefault();
            loadTable(sortLink.href);
        }
        const pageLink = e.target.closest('.page-link');
        if (pageLink && pageLink.href) {
            e.preventDefault();
            loadTable(pageLink.href);
        }
    });

    function getSearchUrl() {
        const url = new URL(window.location.href.split('?')[0]);
        const formData = new FormData(form);
        for (const [key, value] of formData.entries()) {
            url.searchParams.append(key, value);
        }
        url.searchParams.set('ajax', '1');
        return url.toString();
    }

    function loadTable(url) {
        if (!container) return;
        container.innerHTML = `
            <div class="text-center my-5">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Lade...</span>
                </div>
            </div>`;

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.querySelector(`#${containerId}`);
                if (newContent) {
                    container.innerHTML = newContent.innerHTML;
                    history.replaceState({}, '', url);
                } else {
                    container.innerHTML = `<div class="alert alert-danger">Fehler beim Laden der Tabelle</div>`;
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Tabelle:', error);
                container.innerHTML = `<div class="alert alert-danger">Fehler beim Laden der Tabelle</div>`;
            });
    }
});
</script>
{% endblock %}
