{% extends 'base.html.twig' %}

{% block title %}Firma bearbeiten{% endblock %}

{% block body %}
<div class="container py-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-building"></i> Firma bearbeiten</h4>
        </div>
        <div class="card-body">

            {% if form.vars.errors|length > 0 %}
                <div class="alert alert-danger">
                    {{ form_errors(form) }}
                </div>
            {% endif %}

            {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

            <ul class="nav nav-tabs mb-3" id="companyTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="tab-general" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                        <i class="bi bi-card-list"></i> Allgemein
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-address" data-bs-toggle="tab" data-bs-target="#address" type="button" role="tab">
                        <i class="bi bi-geo-alt"></i> Adresse
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-contact" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">
                        <i class="bi bi-telephone"></i> Kontakt
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-tax" data-bs-toggle="tab" data-bs-target="#tax" type="button" role="tab">
                        <i class="bi bi-receipt"></i> Steuern & Nummernkreis
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tab-logo" data-bs-toggle="tab" data-bs-target="#logo" type="button" role="tab">
                        <i class="bi bi-image"></i> Logo
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Allgemein -->
                <div class="tab-pane fade show active" id="general" role="tabpanel">
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            {{ form_label(form.companyname) }}
                            {{ form_widget(form.companyname, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.companyname) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_label(form.ceoprename) }}
                            {{ form_widget(form.ceoprename, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.ceoprename) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_label(form.ceoname) }}
                            {{ form_widget(form.ceoname, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.ceoname) }}
                        </div>
                    </div>
                </div>

                <!-- Adresse -->
                <div class="tab-pane fade" id="address" role="tabpanel">
                    <div class="row g-3 mt-2">
                        <div class="col-md-7">
                            {{ form_label(form.street) }}
                            {{ form_widget(form.street, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.street) }}
                        </div>
                        <div class="col-md-2">
                            {{ form_label(form.streetno) }}
                            {{ form_widget(form.streetno, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.streetno) }}
                        </div>
                        <div class="col-md-3">
                            {{ form_label(form.zipcode) }}
                            {{ form_widget(form.zipcode, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.zipcode) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.city) }}
                            {{ form_widget(form.city, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.city) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.location) }}
                            {{ form_widget(form.location, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.location) }}
                        </div>
                    </div>
                </div>

                <!-- Kontakt -->
                <div class="tab-pane fade" id="contact" role="tabpanel">
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            {{ form_label(form.phone) }}
                            {{ form_widget(form.phone, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.phone) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.fax) }}
                            {{ form_widget(form.fax, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.fax) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.email) }}
                            {{ form_widget(form.email, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.email) }}
                        </div>
                        <div class="col-md-8">
                            {{ form_label(form.web) }}
                            {{ form_widget(form.web, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.web) }}
                        </div>
                    </div>
                </div>

                <!-- Steuern & Nummernkreis -->
                <div class="tab-pane fade" id="tax" role="tabpanel">
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            {{ form_label(form.taxno) }}
                            {{ form_widget(form.taxno, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.taxno) }}
                        </div>
                        <div class="col-md-4">
                            {{ form_label(form.taxid) }}
                            {{ form_widget(form.taxid, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.taxid) }}
                        </div>
                        <div class="col-md-2">
                            {{ form_label(form.personalNrMin) }}
                            {{ form_widget(form.personalNrMin, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.personalNrMin) }}
                        </div>
                        <div class="col-md-2">
                            {{ form_label(form.personalNrMax) }}
                            {{ form_widget(form.personalNrMax, {'attr': {'class': 'form-control'}}) }}
                            {{ form_errors(form.personalNrMax) }}
                        </div>
                    </div>
                </div>

                <!-- Logo -->
                <div class="tab-pane fade" id="logo" role="tabpanel">
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <label for="companyLogoFileInput" class="form-label">Firmenlogo hochladen</label>
                            <div id="dropzone" class="dropzone border rounded-3 p-3 text-center bg-light" style="cursor:pointer;">
                                <p id="dropzone-text" class="mb-0">
                                    ðŸ“‚ Hier Bild ablegen oder klicken zum AuswÃ¤hlen.
                                </p>
                                <input type="file" id="companyLogoFileInput" accept="image/*" style="display:none;">
                            </div>
                            <div id="file-name" class="small text-muted mt-2 text-center">
                                {% if company.companyLogo %}
                                    {{ company.companyLogo }}
                                {% else %}
                                    Keine Datei ausgewÃ¤hlt
                                {% endif %}
                            </div>
                            {# Das eigentliche (versteckte, readonly) Symfony-Feld â€“ fÃ¼r den Dateinamen #}
                            {{ form_widget(form.companyLogo) }}
                        </div>
                        <div class="col-md-6 text-center">
                            <label class="form-label">Vorschau</label>
                            <div class="image-preview">
                                {% if company.companyLogo %}
                                    <img id="uploadedImagePreview"
                                        src="/uploads/{{ company.companyLogo }}"
                                        alt="Image Preview"
                                        style="display:block; max-width: 180px; max-height: 180px;">
                                {% else %}
                                    <img id="uploadedImagePreview"
                                        src=""
                                        alt="Image Preview"
                                        style="display:none; max-width: 180px; max-height: 180px;">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-end mt-4">
                <button class="btn btn-primary">
                    <i class="bi bi-save"></i> Speichern
                </button>
                <a href="{{ path('app_company_index') }}" class="btn btn-outline-secondary ms-2">
                    <i class="bi bi-arrow-left"></i> ZurÃ¼ck
                </a>
            </div>
            {{ form_end(form) }}
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("companyLogoFileInput");
    const fileNameDisplay = document.getElementById("file-name");
    const imagePreview = document.getElementById("uploadedImagePreview");
    const symfonyLogoField = document.querySelector('input[name$="[companyLogo]"]');

    if (!dropzone || !fileInput || !fileNameDisplay || !imagePreview || !symfonyLogoField) {
        // Robustness: Brich ab, wenn ein wichtiges Element fehlt.
        return;
    }

    // Klickbare Dropzone
    dropzone.addEventListener("click", function () {
        fileInput.click();
    });

    // Drag & Drop Optik
    dropzone.addEventListener("dragover", function(e) {
        e.preventDefault();
        dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", function(e) {
        e.preventDefault();
        dropzone.classList.remove("dragover");
    });
    dropzone.addEventListener("drop", function(e) {
        e.preventDefault();
        dropzone.classList.remove("dragover");
        if (e.dataTransfer.files.length > 0) {
            handleFileUpload(e.dataTransfer.files[0]);
        }
    });

    // Klassisches FileInput onchange -> Upload starten
    fileInput.addEventListener("change", function () {
        if (fileInput.files.length > 0) {
            handleFileUpload(fileInput.files[0]);
        }
    });

    function handleFileUpload(file) {
        fileNameDisplay.textContent = file.name;

        let formData = new FormData();
        formData.append("file", file);

        fetch("/admin/upload-image", {
            method: "POST",
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.location) {
                // Nur Dateiname aus location extrahieren
                let filename = data.location.split('/').pop();
                imagePreview.src = '/uploads/' + filename;
                imagePreview.style.display = 'block';
                symfonyLogoField.value = filename; // Nur Dateiname ins Symfony-Feld!
            } else {
                alert("Fehler beim Hochladen: " + data.error);
            }
        })
        .catch(error => {
            console.error("Fehler beim Upload:", error);
            alert("Fehler beim Hochladen.");
        });
    }
});
</script>
{% endblock %}
