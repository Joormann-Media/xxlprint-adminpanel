{% extends 'base.html.twig' %}
{% block title %}Taxi Fahrpreisrechner{% endblock %}
{% block body %}
<div class="container py-4">
    <h2>ðŸš• Taxi Fahrpreisrechner</h2>
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <form id="taxi-calc-form" autocomplete="off" onsubmit="return false;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="start_address" class="form-label">Startadresse</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="start_address" class="form-control" placeholder="Startadresse suchen" autocomplete="off">
                            <div id="start_address_suggestions" class="address-suggestion-box"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="end_address" class="form-label">Zieladresse</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="end_address" class="form-control" placeholder="Zieladresse suchen" autocomplete="off">
                            <div id="end_address_suggestions" class="address-suggestion-box"></div>
                        </div>
                    </div>
                </div>

                <div id="map" style="height:400px; border-radius:1em;" class="mt-3"></div>

                <div class="row g-3 mt-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">Fahrtzeitpunkt</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="datetime_choice" id="now" value="now" checked>
                            <label class="form-check-label" for="now">Jetzt</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="datetime_choice" id="custom" value="custom">
                            <label class="form-check-label" for="custom">Datum & Uhrzeit wÃ¤hlen</label>
                        </div>
                        <input type="datetime-local" class="form-control mt-2" id="custom_datetime" style="display:none;">
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col d-flex justify-content-end">
                        <button type="submit" id="calc_btn" class="btn btn-success px-4" disabled>
                            <i class="bi bi-cash-coin"></i> Preis berechnen
                        </button>
                    </div>
                </div>
            </form>

            <div id="calculated_price" class="card shadow-sm mt-3" style="display:none;">
                <div class="card-body">
                    <h4 class="card-title mb-2">
                        Fahrpreis: <strong id="price_val"></strong>
                    </h4>
                    <p class="card-text text-muted" id="route_info"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

<style>
.address-suggestion-box {
    position: absolute;
    z-index: 3000;
    background: white;
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    left: 0;
    top: 100%;
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    border-radius: 0 0 8px 8px;
    font-size: 1rem;
}
.autocomplete-wrapper {
    position: relative;
    width: 100%;
}
.address-suggestion-box .suggestion:hover {
    background: #0d6efd;
    color: #fff;
    cursor: pointer;
}
</style>

<script>
// --- MapLibre Setup ---
const map = new maplibregl.Map({
    container: 'map',
    style: 'https://tiles.joormann-media.de/styles/basic/style.json',
    center: [7.0, 51.5],
    zoom: 9
});

let startMarker, endMarker;
let startCoords, endCoords;

function updateCalcButton() {
    document.getElementById('calc_btn').disabled = !(startCoords && endCoords);
}

// --- Autocomplete ---
function debounce(fn, delay) {
    let timer = null;
    return function(...args) {
        if (timer) clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
    };
}

function setupAddressAutocomplete(inputId, suggestionId, setCoordsCallback) {
    const input = document.getElementById(inputId);
    const suggestionBox = document.getElementById(suggestionId);

    input.addEventListener('input', debounce(function() {
        suggestionBox.innerHTML = '';
        if (input.value.length < 3) return updateCalcButton();

        fetch('/taxi-calculator/api/geocode?q=' + encodeURIComponent(input.value))
            .then(res => res.json())
            .then(data => {
                if (!Array.isArray(data)) return;
                suggestionBox.innerHTML = data.map(item =>
                    `<div class="p-2 suggestion" data-lat="${item.lat}" data-lon="${item.lon}" style="cursor:pointer;">${item.display_name}</div>`
                ).join('');
            });
    }, 300));

    suggestionBox.addEventListener('click', function(e) {
        if (e.target.classList.contains('suggestion')) {
            let lat = parseFloat(e.target.getAttribute('data-lat'));
            let lon = parseFloat(e.target.getAttribute('data-lon'));
            input.value = e.target.textContent;
            setCoordsCallback(lon, lat); // Speichern als [lon, lat]
            suggestionBox.innerHTML = '';
        }
    });
}

// --- Marker setzen ---
function setStartCoords(lon, lat) {
    startCoords = [lon, lat];
    if (startMarker) startMarker.remove();
    startMarker = new maplibregl.Marker({color: 'green'}).setLngLat(startCoords).addTo(map);
    map.flyTo({center: startCoords, zoom: 14});
    updateCalcButton();
}
function setEndCoords(lon, lat) {
    endCoords = [lon, lat];
    if (endMarker) endMarker.remove();
    endMarker = new maplibregl.Marker({color: 'red'}).setLngLat(endCoords).addTo(map);
    map.flyTo({center: endCoords, zoom: 14});
    updateCalcButton();
}

setupAddressAutocomplete('start_address', 'start_address_suggestions', setStartCoords);
setupAddressAutocomplete('end_address', 'end_address_suggestions', setEndCoords);

// Fahrtzeitpunkt Umschalten
document.querySelectorAll('input[name="datetime_choice"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('custom_datetime').style.display = (this.value === 'custom') ? 'block' : 'none';
    });
});

// --- Formular Submit ---
document.getElementById('taxi-calc-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!(startCoords && endCoords)) return;

    let datetimeChoice = document.querySelector('input[name="datetime_choice"]:checked').value;
    let dateTime = (datetimeChoice === 'custom') ? document.getElementById('custom_datetime').value : null;

    const priceCard = document.getElementById('calculated_price');
    const priceVal = document.getElementById('price_val');
    const routeInfo = document.getElementById('route_info');

    priceCard.style.display = 'none';

    fetch('/taxi-calculator/api/calculate-route', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            start: { lat: startCoords[1], lon: startCoords[0] },
            end: { lat: endCoords[1], lon: endCoords[0] },
            datetime: dateTime
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.price !== undefined) {
            priceVal.innerText = `${data.price.toFixed(2).replace('.', ',')} â‚¬`;
            routeInfo.innerText = `Strecke: ${data.distance.toFixed(2)} km â€¢ Fahrzeit: ${Math.round(data.duration/60)} min`;
            priceCard.style.display = 'block';

            // Route zeichnen
            if (map.getLayer('route-line')) {
                map.removeLayer('route-line');
                map.removeSource('route');
            }
            if (data.geometry && data.geometry.coordinates) {
                map.addSource('route', {
                    type: 'geojson',
                    data: { type: 'Feature', geometry: data.geometry }
                });
                map.addLayer({
                    id: 'route-line',
                    type: 'line',
                    source: 'route',
                    paint: { 'line-color': '#007bff', 'line-width': 5 }
                });

                // Bounds setzen
                const coords = data.geometry.coordinates;
                const bounds = coords.reduce(
                    (b, coord) => b.extend(coord),
                    new maplibregl.LngLatBounds(coords[0], coords[0])
                );
                map.fitBounds(bounds, {padding: 50});
            }
        } else if (data.error) {
            priceVal.innerText = 'Fehler';
            routeInfo.innerText = data.error;
            priceCard.style.display = 'block';
        }
    })
    .catch(err => {
        priceVal.innerText = 'Fehler';
        routeInfo.innerText = err.message;
        priceCard.style.display = 'block';
    });
});
</script>
{% endblock %}
