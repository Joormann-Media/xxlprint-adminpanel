{# templates/stop_point/show.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Stop Point: {{ stop_point.name|default('—') }}{% endblock %}

{% block body %}
<div class="container py-4">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
        <i class="bi bi-geo-alt"></i> Stop Point Details
    </h2>
    <div class="btn-group" role="group">
        <a href="{{ path('app_stop_point_edit', {'id': stop_point.id}) }}" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        <a href="{{ path('app_stop_point_index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <form method="post" action="{{ path('app_stop_point_delete', {'id': stop_point.id}) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this item?');">
            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ stop_point.id) }}">
            <button class="btn btn-danger" type="submit">
                <i class="bi bi-trash"></i> Delete
            </button>
        </form>
    </div>
</div>


    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="mb-3">General Info</h5>
                    <table class="table table-sm mb-0">
                        <tbody>
                            <tr><th>ID</th><td>{{ stop_point.id }}</td></tr>
                            <tr><th>Name</th><td>{{ stop_point.name }}</td></tr>
                            <tr>
                                <th>Type</th>
                                <td>
                                    {{ stop_point.type|capitalize }}
                                    {% if stop_point.stopPointIcon %}
                                        <span class="ms-2" style="font-size:1.5em;">{{ stop_point.stopPointIcon|raw }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Street</th>
                                <td>
                                    {{ stop_point.street }}
                                    {% if stop_point.streetNumber %} {{ stop_point.streetNumber }}{% endif %}
                                    {% if stop_point.crossingStreet %}
                                        <br><small class="text-muted">Crossing: {{ stop_point.crossingStreet }}</small>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>ZIP / City</th>
                                <td>
                                    {{ stop_point.zip }} {{ stop_point.city }}
                                </td>
                            </tr>
                            <tr>
                                <th>GPS</th>
                                <td>
                                    {% if stop_point.latitude and stop_point.longitude %}
                                        <code>{{ stop_point.latitude }}, {{ stop_point.longitude }}</code>
                                        <a href="https://www.openstreetmap.org/?mlat={{ stop_point.latitude }}&mlon={{ stop_point.longitude }}#map=16/{{ stop_point.latitude }}/{{ stop_point.longitude }}" 
                                           class="ms-2 text-decoration-none" target="_blank" title="View on OSM">
                                            <i class="bi bi-map"></i>
                                        </a>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Max Persons</th>
                                <td>{{ stop_point.maxPersons|default('—') }}</td>
                            </tr>
                            <tr>
                                <th>Notes</th>
                                <td>{{ stop_point.notes|nl2br|raw }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="mb-3"><i class="bi bi-map"></i> Saved Map View</h5>
                    <div id="map-show" style="height:320px;width:100%;border-radius: 1rem;box-shadow:0 1px 8px #0002;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{# --- Leaflet Map & MapViewport Rendering --- #}


<script>
document.addEventListener("DOMContentLoaded", function () {
    const viewport = {{ stop_point.mapViewport|default('{}')|json_encode|json_encode|raw }};
    const hasCoords = {{ (stop_point.latitude and stop_point.longitude) ? 'true' : 'false' }};
    const lat = {{ stop_point.latitude|default('null') }};
    const lon = {{ stop_point.longitude|default('null') }};
    let center = [51.7, 6.5]; // Fallback Niederrhein :-D
    let zoom = 14;
    if (viewport && viewport.center && viewport.zoom) {
        center = viewport.center;
        zoom = viewport.zoom;
    } else if (hasCoords && lat && lon) {
        center = [lat, lon];
        zoom = 16;
    }

    const map = L.map('map-show').setView(center, zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://osm.org/copyright">OSM</a>'
    }).addTo(map);

    // Marker, nur wenn Koordinaten da
    if (hasCoords && lat && lon) {
        L.marker([lat, lon]).addTo(map)
            .bindPopup(`
                <strong>{{ stop_point.name|e }}</strong><br>
                {{ stop_point.street|e }} {{ stop_point.streetNumber|e }}<br>
                {{ stop_point.zip|e }} {{ stop_point.city|e }}
            `)
            .openPopup();
    }
});
</script>
{% endblock %}
