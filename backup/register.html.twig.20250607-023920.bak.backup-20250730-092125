{% extends 'base.html.twig' %}

{% block title %}Registrierung{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Benutzer registrieren</h4>
        </div>
        <div class="card-body">
            {{ form_start(form, {'attr': {'enctype': 'multipart/form-data'}}) }}

            <div class="row">
                <!-- Linke Spalte -->
                <div class="col-md-6">
                    <h5 class="mb-3">Benutzerinformationen</h5>

                    <div class="mb-3">
                        {{ form_label(form.email, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.email, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.email) }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form_label(form.username, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.username, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.username) }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form_label(form.prename, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.prename, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.prename) }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form_label(form.name, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.name, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.name) }}
                    </div>
                    
                    <div class="mb-3 position-relative">
                        {{ form_label(form.plainPassword, null, {'label_attr': {'class': 'form-label'}}) }}
                        <div class="input-group">
                            {{ form_widget(form.plainPassword, {'attr': {'class': 'form-control'}}) }}
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleVisibility('{{ form.plainPassword.vars.id }}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="generatePassword('{{ form.plainPassword.vars.id }}')">
                                <i class="bi bi-shuffle"></i>
                            </button>
                        </div>
                        
                        {{ form_errors(form.plainPassword) }}
                    </div>
                    
                    <div class="mb-3 position-relative">
                        {{ form_label(form.userpin, null, {'label_attr': {'class': 'form-label'}}) }}
                        <div class="input-group">
                            {{ form_widget(form.userpin, {'attr': {'class': 'form-control', 'maxlength': 4, 'inputmode': 'numeric'}}) }}
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleVisibility('{{ form.userpin.vars.id }}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="generatePin('{{ form.userpin.vars.id }}')">
                                <i class="bi bi-shuffle"></i>
                            </button>
                        </div>
                        
                        {{ form_errors(form.userpin) }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form_label(form.avatar, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.avatar, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.avatar) }}
                    </div>


                    <div class="form-check mb-3">
                        {{ form_widget(form.agreeTerms, {'attr': {'class': 'form-check-input'}}) }}
                        {{ form_label(form.agreeTerms, null, {'label_attr': {'class': 'form-check-label'}}) }}
                        {{ form_errors(form.agreeTerms) }}
                    </div>

                    <div class="mb-3">
                        {{ form_label(form.roles, null, {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(form.roles, {'attr': {'class': 'form-select'}}) }}
                        {{ form_errors(form.roles) }}
                    </div>
                </div>

                <!-- Rechte Spalte -->
                <div class="col-md-6">
                    <div class="mt-4">
                        <h5 class="text-muted">üîç Transparenzhinweis zu den mitgeloggten Daten</h5>
                        <div id="fingerprint-preview" class="bg-light border rounded p-3 mt-2" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem;">
                            <div class="text-muted">Lade Ger√§teinformationen‚Ä¶</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <a href="{{ path('app_user_index') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Zur√ºck
                </a>
                <button class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Registrieren
                </button>
            </div>
            <div style="display: none;">
                {{ form_widget(form.isActive) }}
                {{ form_widget(form.isTwoFactorEnabled) }}
                {{ form_widget(form.twoFactorSecret) }}
                {{ form_widget(form.adminOverride) }}
                {{ form_widget(form.adminOverrideId) }}
                {{ form_widget(form.regDate) }}
                {{ form_widget(form.lastlogindate) }}
                {{ form_widget(form.passwordChangedAt) }}
                {{ form_widget(form.failedAttempts) }}
                {{ form_widget(form.isLocked) }}
                {{ form_widget(form.isVerified) }}
                {{ form_widget(form.permissions) }}
                {{ form_widget(form.usergroups) }}
            </div>
            {{ form_end(form) }}
        </div>
    </div>
</div>


<script>
    document.addEventListener('fingerprint-ready', function (e) {
        const fingerprintField = document.querySelector('[name="registration_form[fingerprintData]"]');
        if (fingerprintField && e.detail) {
            fingerprintField.value = JSON.stringify(e.detail);
        }
    });
</script>
{% block javascripts %}
    {{ parent() }}
    <script type="module">
        document.addEventListener('fingerprint-ready', function (e) {
            const data = e.detail;
            const container = document.getElementById('fingerprint-preview');
            if (container && data) {
                let html = '<table class="table table-sm table-striped mb-0">';
for (const key in data) {
    html += `<tr><th>${key}</th><td>${data[key] ?? '-'}</td></tr>`;
}
html += '</table>';
container.innerHTML = html;

            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Passwort anzeigen/verstecken
            window.toggleVisibility = function (id) {
                const input = document.getElementById(id);
                if (input) {
                    input.type = input.type === 'password' ? 'text' : 'password';
                }
            };

            // Passwort generieren (6-16 Zeichen, mindestens 1 Gro√übuchstabe, 1 Zahl, 1 Sonderzeichen)
            window.generatePassword = function (id) {
                const input = document.getElementById(id);
                if (input) {
                    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+";
                    const min = 6, max = 16;
                    let password = "";

                    while (true) {
                        password = "";
                        let hasUpper = false, hasDigit = false, hasSpecial = false;
                        const length = Math.floor(Math.random() * (max - min + 1)) + min;

                        for (let i = 0; i < length; i++) {
                            const char = charset[Math.floor(Math.random() * charset.length)];
                            password += char;
                            if (/[A-Z]/.test(char)) hasUpper = true;
                            if (/\d/.test(char)) hasDigit = true;
                            if (/[\W_]/.test(char)) hasSpecial = true;
                        }

                        if (hasUpper && hasDigit && hasSpecial) break;
                    }

                    input.value = password; // Setze das generierte Passwort in das Feld
                    console.log('Password generated!');
                } else {
                    console.error(`Element with ID '${id}' not found.`);
                }
            };

            // PIN generieren (nur 4-stellig, nur Zahlen)
            generatePin = function (id) {
                const input = document.getElementById(id);
                if (input) {
                    const pin = Math.floor(1000 + Math.random() * 9000).toString();
                    input.value = pin; // Setze die generierte PIN in das Feld
                    console.log('PIN generated!');
                } else {
                    console.error(`Element with ID '${id}' not found.`);
                }
            };

            // Fingerprint Vorschau anzeigen
            document.addEventListener('fingerprint-ready', function (e) {
                const data = e.detail;
                const container = document.getElementById('fingerprint-preview');
                if (container && data) {
                    let html = '<table class="table table-sm table-striped mb-0">';
                    for (const key in data) {
                        html += `<tr><th>${key}</th><td>${data[key] ?? '-'}</td></tr>`;
                    }
                    html += '</table>';
                    container.innerHTML = html;
                }
            });
        });
    </script>
{% endblock %}

{% endblock %}
