<?php

namespace App\Controller;

use App\Entity\School;
use App\Form\SchoolType;
use App\Repository\SchoolRepository;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Attribute\Route;
use App\Service\AddressFinder;

#[Route('/school')]
final class SchoolController extends AbstractController
{
    #[Route(name: 'app_school_index', methods: ['GET'])]
    public function index(SchoolRepository $schoolRepository): Response
    {
        return $this->render('school/index.html.twig', [
            'schools' => $schoolRepository->findAll(),
            'page_title' => 'Schulen',
        ]);
    }

    #[Route('/new', name: 'app_school_new', methods: ['GET', 'POST'])]
    public function new(Request $request, EntityManagerInterface $entityManager): Response
    {
        $school = new School();
        $form = $this->createForm(SchoolType::class, $school);
        $form->handleRequest($request);

        if ($form->isSubmitted() && $form->isValid()) {
            $entityManager->persist($school);
            $entityManager->flush();

            return $this->redirectToRoute('app_school_index', [], Response::HTTP_SEE_OTHER);
        }

        return $this->render('school/new.html.twig', [
            'school' => $school,
            'form' => $form,
            'page_title' => 'Neue Schule',
        ]);
    }

    #[Route('/{id<\d+>}', name: 'app_school_show', methods: ['GET'])]
    public function show(School $school): Response
    {
        return $this->render('school/show.html.twig', [
            'school' => $school,
            'page_title' => 'Schule anzeigen',
        ]);
    }

    #[Route('/{id<\d+>}/edit', name: 'app_school_edit', methods: ['GET', 'POST'])]
public function edit(Request $request, School $school, EntityManagerInterface $entityManager): Response
{
    // 1. Aktuelle Address-ID herausfinden (egal ob GET oder POST)
    $currentAddressId = null;
    if ($request->isMethod('POST')) {
        // Bei POST liegt der Wert im Request
        $formData = $request->request->all();
        if (isset($formData['school']['address']) && $formData['school']['address']) {
            $currentAddressId = $formData['school']['address'];
        }
    } elseif ($school->getAddress()) {
        // Bei GET/Edit ist sie schon gesetzt
        $currentAddressId = $school->getAddress()->getId();
    }

    // 2. Form anlegen und die aktuelle Address-ID mitgeben!
    $form = $this->createForm(SchoolType::class, $school, [
        'current_address_id' => $currentAddressId,
    ]);
    $form->handleRequest($request);

    // Optional: Debugging, falls noch gebraucht
    // dump($form->get('address')->getData());
    // dump($form->getErrors(true, false));
    // die();

    if ($form->isSubmitted() && $form->isValid()) {
        $entityManager->flush();

        return $this->redirectToRoute('app_school_index', [], Response::HTTP_SEE_OTHER);
    }

    return $this->render('school/edit.html.twig', [
        'school' => $school,
        'form' => $form,
        'page_title' => 'Schule bearbeiten',
    ]);
}


    #[Route('/{id<\d+>}', name: 'app_school_delete', methods: ['POST'])]
    public function delete(Request $request, School $school, EntityManagerInterface $entityManager): Response
    {
        if ($this->isCsrfTokenValid('delete'.$school->getId(), $request->getPayload()->getString('_token'))) {
            $entityManager->remove($school);
            $entityManager->flush();
        }

        return $this->redirectToRoute('app_school_index', [], Response::HTTP_SEE_OTHER);
    }
    #[Route('/{id<\d+>}/assign-address', name: 'app_school_assign_address', methods: ['POST'])]
public function assignAddress(
    School $school,
    AddressFinder $addressFinder,
    EntityManagerInterface $em
): Response {
    if ($school->getAddress() !== null) {
        $this->addFlash('info', 'Adresse ist bereits zugeordnet.');
    } else {
        $addressData = [
            'zip'      => $school->getZip(),
            'city'     => $school->getCity(),
            'street'   => $school->getStreet(),
            'streetNo' => $school->getStreetNo(),
        ];
        $officialAddress = $addressFinder->findByFields($addressData);

        if ($officialAddress) {
            $school->setAddress($officialAddress);
            $em->persist($school);
            $em->flush();
            $this->addFlash('success', 'Adresse erfolgreich zugeordnet!');
        } else {
            $this->addFlash('warning', 'Keine passende Adresse gefunden. Importiere oder korrigiere die Adresse zuerst!');
        }
    }
    return $this->redirectToRoute('app_school_index');
}
#[Route('/bulk-assign-addresses', name: 'app_school_bulk_assign_addresses', methods: ['POST'])]
public function bulkAssignAddresses(
    SchoolRepository $schoolRepository,
    AddressFinder $addressFinder,
    EntityManagerInterface $em
): Response {
    $schools = $schoolRepository->findAll();
    $countMatched = 0;
    $countMissing = 0;

    foreach ($schools as $school) {
        // Wenn schon gesetzt: Überspringen
        if ($school->getAddress() !== null) {
            continue;
        }

        $addressData = [
            'zip'      => $school->getZip(),
            'city'     => $school->getCity(),
            'street'   => $school->getStreet(),
            'streetNo' => $school->getStreetNo(),
        ];

        $officialAddress = $addressFinder->findByFields($addressData);

        if ($officialAddress) {
            $school->setAddress($officialAddress);
            $em->persist($school);
            $countMatched++;
        } else {
            $countMissing++;
            // Optional: Logging oder Liste für spätere Anzeige
        }
    }

    $em->flush();

    $this->addFlash('success', "Bulk-Mapping abgeschlossen. $countMatched Adressen zugeordnet, $countMissing nicht gefunden.");

    return $this->redirectToRoute('app_school_index');
}

}
