{{ form_start(form, {'attr': {'autocomplete': 'off'}}) }}

<div class="container-fluid p-0">
  <div class="card shadow border-0 rounded-4 mb-4">
    <div class="card-header bg-primary bg-gradient text-white fw-bold fs-5">
      <i class="bi bi-cpu me-2"></i>
      {% if form.vars.value.id %}
        KI-Manager bearbeiten
      {% else %}
        Neue KI eintragen
      {% endif %}
    </div>
    <div class="card-body pb-1">
      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="aiFormTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="allgemein-tab" data-bs-toggle="tab" data-bs-target="#allgemein" type="button" role="tab" aria-controls="allgemein" aria-selected="true">
            <i class="bi bi-info-circle"></i> Allgemein
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup" type="button" role="tab" aria-controls="setup" aria-selected="false">
            <i class="bi bi-gear"></i> Setup & System
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status" type="button" role="tab" aria-controls="status" aria-selected="false">
            <i class="bi bi-activity"></i> Status & Monitoring
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="berechtigung-tab" data-bs-toggle="tab" data-bs-target="#berechtigung" type="button" role="tab" aria-controls="berechtigung" aria-selected="false">
            <i class="bi bi-unlock"></i> Berechtigungen
          </button>
        </li>
      </ul>
      <div class="tab-content" id="aiFormTabsContent">
        <!-- Tab 1: Allgemein -->
        <div class="tab-pane fade show active" id="allgemein" role="tabpanel" aria-labelledby="allgemein-tab">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name *</label>
              {{ form_widget(form.aiName, {'attr': {'class': 'form-control', 'placeholder': 'z.B. Jarvis'}}) }}
              {{ form_errors(form.aiName) }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Modell</label>
              {{ form_widget(form.aiModel, {'attr': {'class': 'form-control', 'placeholder': 'mistral, xtts ...'}}) }}
              {{ form_errors(form.aiModel) }}
            </div>
            <div class="col-md-12">
              <label class="form-label">Beschreibung</label>
              {{ form_widget(form.aiDescription, {'attr': {'class': 'form-control', 'rows': 2, 'placeholder': 'Was macht die KI?'}}) }}
              {{ form_errors(form.aiDescription) }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Avatar - Upload</label>
                  
    <div id="avatar-dropzone" class="dropzone"></div>
    <small class="text-muted">Zulässig: PNG/JPG, max. 15 MB. Nach Upload wird der Dateiname automatisch übernommen.</small>
    {{ form_widget(form.aiAvatar, {'attr': {'class': 'form-control avatar-filename-field', 'readonly': true}}) }}

    {{ form_errors(form.aiAvatar) }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Status</label>
              {{ form_widget(form.aiStatus, {'attr': {'class': 'form-select'}}) }}
              {{ form_errors(form.aiStatus) }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Kategorie</label>
              {{ form_widget(form.aiCategory, {'attr': {'class': 'form-select'}}) }}
              {{ form_errors(form.aiCategory) }}
            </div>
          </div>
        </div>
        <!-- Tab 2: Setup & System -->
        <div class="tab-pane fade" id="setup" role="tabpanel" aria-labelledby="setup-tab">
          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">Setup (Abhängigkeiten)</label>
              {{ form_widget(form.aiSetup, {'attr': {'class': 'form-control', 'rows': 2}}) }}
              {{ form_errors(form.aiSetup) }}
            </div>
            <div class="col-md-4">
              <label class="form-label">Pfad</label>
              {{ form_widget(form.aiPath, {'attr': {'class': 'form-control'}}) }}
              {{ form_errors(form.aiPath) }}
            </div>
            <div class="col-md-4">
              <label class="form-label">Host</label>
              {{ form_widget(form.aiHost, {'attr': {'class': 'form-control'}}) }}
              {{ form_errors(form.aiHost) }}
            </div>
          </div>
        </div>
        <!-- Tab 3: Status & Monitoring -->
        <div class="tab-pane fade" id="status" role="tabpanel" aria-labelledby="status-tab">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Health-URL</label>
              {{ form_widget(form.aiHealthUrl, {'attr': {'class': 'form-control'}}) }}
              {{ form_errors(form.aiHealthUrl) }}
            </div>
            <div class="col-md-6">
              <label class="form-label">API-Token</label>
              {{ form_widget(form.aiApiToken, {'attr': {'class': 'form-control'}}) }}
              {{ form_errors(form.aiApiToken) }}
            </div>
            <div class="col-md-4">
              <label class="form-label">Letzter Check</label>
              {{ form_widget(form.aiLastCheckedAt, {'attr': {'class': 'form-control'}}) }}
              {{ form_errors(form.aiLastCheckedAt) }}
            </div>
            <div class="col-md-4">
              <label class="form-label">Antwortzeit (ms)</label>
              {{ form_widget(form.aiLastResponseMs, {'attr': {'class': 'form-control'}}) }}
              {{ form_errors(form.aiLastResponseMs) }}
            </div>
            <div class="col-md-4">
              <label class="form-label">Fehler</label>
              {{ form_widget(form.aiLastError, {'attr': {'class': 'form-control'}}) }}
              {{ form_errors(form.aiLastError) }}
            </div>
          </div>
        </div>
        <!-- Tab 4: Berechtigungen -->
        <div class="tab-pane fade" id="berechtigung" role="tabpanel" aria-labelledby="berechtigung-tab">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Maintainer</label>
              {{ form_widget(form.aiMaintainer, {'attr': {'class': 'form-select'}}) }}
              {{ form_errors(form.aiMaintainer) }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Minimalrolle</label>
              {{ form_widget(form.aiMinrole, {'attr': {'class': 'form-select'}}) }}
              {{ form_errors(form.aiMinrole) }}
            </div>
            <div class="col-md-6">
              <label class="form-label">Angelegt am</label>
              {{ form_widget(form.aiCreated, {'attr': {'class': 'form-control'}}) }}
              {{ form_errors(form.aiCreated) }}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card-footer bg-light border-0 py-3 text-end">
      <button class="btn btn-success px-4">
        <i class="bi bi-save me-1"></i> Speichern
      </button>
      <a href="{{ path('app_ai_manager_index') }}" class="btn btn-secondary ms-2 px-4">
        <i class="bi bi-arrow-left"></i> Zurück
      </a>
    </div>
  </div>
</div>
{{ form_end(form) }}

<script>
  // Bootstrap 5: Tabs (wird einmalig initialisiert, falls Tab-Persistenz nötig ist)
  document.addEventListener('DOMContentLoaded', function() {
    let triggerTabList = [].slice.call(document.querySelectorAll('#aiFormTabs button'))
    triggerTabList.forEach(function (triggerEl) {
      let tabTrigger = new bootstrap.Tab(triggerEl)
      triggerEl.addEventListener('click', function (event) {
        event.preventDefault()
        tabTrigger.show()
      })
    })
  });

  document.addEventListener("DOMContentLoaded", function() {
    // Initialisiere Dropzone für den Avatar-Upload
    if (window.Dropzone) {
        Dropzone.autoDiscover = false;
        const dz = new Dropzone("#avatar-dropzone", {
            url: "{{ path('ai_manager_upload_avatar') }}",
            maxFiles: 1,
            acceptedFiles: "image/*",
            dictDefaultMessage: "Avatar hierhin ziehen oder klicken",
            addRemoveLinks: true,
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            init: function() {
                this.on("success", function(file, response) {
                    if (response.success) {
                        document.querySelector('.avatar-filename-field').value = 'system-gfx/system-avatars/' + response.filename;
                        // Optional: Vorschau anzeigen
                        let preview = document.getElementById('avatar-preview');
                        if (!preview) {
                            preview = document.createElement('img');
                            preview.id = 'avatar-preview';
                            preview.className = 'rounded mt-2';
                            document.getElementById('avatar-dropzone').appendChild(preview);
                        }
                        preview.src = response.url;
                        preview.style.maxWidth = '110px';
                    } else {
                        alert("Fehler beim Upload: " + (response.error || 'unbekannt'));
                    }
                });
                this.on("removedfile", function(file) {
                    document.querySelector('.avatar-filename-field').value = '';
                    let preview = document.getElementById('avatar-preview');
                    if (preview) preview.remove();
                });
            }
        });
    }
});
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
